<!-- build time:Mon Feb 10 2025 21:47:01 GMT+0800 (中国标准时间) --><!DOCTYPE html><html class="theme-next pisces use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/w2-32x32.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/w2-16x16.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="security i.MX,"><meta name="description" content="背景本文将介绍NXP的AHAB和HAB机制以及差异，详细说明如何一步步使用CST工具对镜像进行签名以及验签的过程。"><meta name="keywords" content="security i.MX"><meta property="og:type" content="article"><meta property="og:title" content="i.MX8 AHAB secure boot porting guide"><meta property="og:url" content="http://wowothink.com/258082eb/index.html"><meta property="og:site_name" content="wowothink"><meta property="og:description" content="背景本文将介绍NXP的AHAB和HAB机制以及差异，详细说明如何一步步使用CST工具对镜像进行签名以及验签的过程。"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://pic.downk.cc/item/5f26229714195aa594625cef.png"><meta property="og:image" content="https://pic.downk.cc/item/5f24e4ca14195aa594f28506.png"><meta property="og:image" content="https://pic.downk.cc/item/5f26229714195aa594625cf1.png"><meta property="og:image" content="https://pic.downk.cc/item/5f26229714195aa594625cf3.png"><meta property="og:image" content="https://pic.downk.cc/item/5f26229714195aa594625cf5.png"><meta property="og:image" content="https://pic.downk.cc/item/5f262c0714195aa5946552e8.png"><meta property="og:image" content="https://pic.downk.cc/item/5f262cc914195aa594659daa.png"><meta property="og:image" content="https://pic.downk.cc/item/5f263aba14195aa59469b993.png"><meta property="og:updated_time" content="2020-08-02T04:02:30.826Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="i.MX8 AHAB secure boot porting guide"><meta name="twitter:description" content="背景本文将介绍NXP的AHAB和HAB机制以及差异，详细说明如何一步步使用CST工具对镜像进行签名以及验签的过程。"><meta name="twitter:image" content="https://pic.downk.cc/item/5f26229714195aa594625cef.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"5.1.4",sidebar:{position:"right",display:"post",offset:12,b2t:!0,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://wowothink.com/258082eb/"><title>i.MX8 AHAB secure boot porting guide | wowothink</title><script>!function(e,t,a,n,c,s,o){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,s=t.createElement(a),o=t.getElementsByTagName(a)[0],s.async=1,s.src=n,o.parentNode.insertBefore(s,o)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-146595331-1","auto"),ga("send","pageview")</script><script data-ad-client="ca-pub-1454282309009428" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-right page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">wowothink</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">thinking all the time</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-folder"></i><br>归档</a></li><li class="menu-item menu-item-邮件"><a href="mailto:hsq_encourage@163.com" rel="section"><i class="menu-item-icon fa fa-fw fa-envelope"></i><br>邮件</a></li><li class="menu-item menu-item-博客"><a href="https://blog.csdn.net/encourage2011" rel="section"><i class="menu-item-icon fa fa-fw fa-crosshairs"></i><br>博客</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://wowothink.com/258082eb/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor Huang"><meta itemprop="description" content=""><meta itemprop="image" content="/images/boy2.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="wowothink"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">i.MX8 AHAB secure boot porting guide</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-08-02T10:09:58+08:00">2020-08-02 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/security-i-MX/" itemprop="url" rel="index"><span itemprop="name">security i.MX</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">4,627 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">22</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>本文将介绍NXP的<code>AHAB</code>和<code>HAB</code>机制以及差异，详细说明如何一步步使用<code>CST</code>工具对镜像进行签名以及验签的过程。<a id="more"></a></p><hr><h2 id="NXP-AHAB介绍（i-MX8使用）"><a href="#NXP-AHAB介绍（i-MX8使用）" class="headerlink" title="NXP AHAB介绍（i.MX8使用）"></a>NXP AHAB介绍（i.MX8使用）</h2><p>资料来源<code>u-boot/doc/imx/ahab/introduction_ahab.txt</code>：<br>AHAB认证基于数字签名，其中使用一个或多个<code>private key</code>离线对镜像数据进行签名。然后使用相应的<code>public key</code>在i.MX处理器上验证所得到的签名镜像数据。<code>public key</code>包含在最终二进制文件中，SRK hash在SoC的fuse中(<code>OTP</code>)，用于建立信任根（确认SRK是否一致）。<br>这里面涉及到的<code>private key</code>和<code>public key</code>都是在<code>CST</code>工具中生成，<code>CST</code>在这里可以认为是一个<code>CA</code>。i.MX8 secure boot流程：</p><p><img src="https://pic.downk.cc/item/5f26229714195aa594625cef.png" alt="i.MX8 secure boot流程"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">1  - At reset, the SCU ROM and SECO ROM both start execution.</span><br><span class="line">2  - The SCU ROM reads the boot configuration and loads the SECO FW (First</span><br><span class="line">     container) from the boot media to the SECO TCM.</span><br><span class="line">3  - A message is sent by the SCU ROM via MU requesting the SECO ROM to</span><br><span class="line">     authenticate the SECO FW which is signed using NXP key.</span><br><span class="line">4  - The SCU ROM loads the second container from the boot media, this container</span><br><span class="line">     must contain at least the SCFW which is signed using the OEM keys.</span><br><span class="line">5  - The SCU ROM loads the SCFW to the SCU TCM, a message is sent via MU</span><br><span class="line">     requesting the SECO FW to authenticate the SCFW and DCD table.</span><br><span class="line">6  - The SCU ROM configures the DDR and loads the M4 and AP images included in</span><br><span class="line">     the second container to their respective load addresses.</span><br><span class="line">7  - The SCU ROM request the SECO FW to authenticate the M4 image.</span><br><span class="line">8  - The SCU ROM request the SECO FW to authenticate the AP image. This image</span><br><span class="line">     is the initial AP core software, depending in the U-Boot target it can</span><br><span class="line">     be the U-Boot and ATF or only SPL.</span><br><span class="line">9  - The SCFW is initialized and starts the ARM Cortex-M and Cortex-A cores.</span><br><span class="line">10 - From this point additional containers can be loaded by Cortex-M and</span><br><span class="line">     Cortex-A cores and authenticated by SECO, the AP SW must interface with</span><br><span class="line">     SCU by calling the sc_misc_seco_authenticate() API function. In current</span><br><span class="line">     U-Boot implementation the additional image can be the Linux Kernel binary</span><br><span class="line">     or the U-Boot proper and ATF. Details about current U-Boot implementation</span><br><span class="line">     can be found in AHAB guides included in doc/imx/ahab/guides/ directory.</span><br></pre></td></tr></table></figure><hr><h2 id="NXP-HAB介绍（i-MX7以下的使用）"><a href="#NXP-HAB介绍（i-MX7以下的使用）" class="headerlink" title="NXP HAB介绍（i.MX7以下的使用）"></a>NXP HAB介绍（i.MX7以下的使用）</h2><p>根据NXP官方文档：<a href="https://www.nxp.com/docs/en/application-note/AN4581.pdf" target="_blank" rel="noopener">Secure Boot on i.MX 50, i.MX 53, i.MX 6 and i.MX 7 Series using HABv4</a> ，我们可以研究一下HAB是个什么东西。</p><h3 id="官方定义"><a href="#官方定义" class="headerlink" title="官方定义"></a>官方定义</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Executing trusted and authentic code on an applications processor starts with securely booting the device.</span><br><span class="line">The i.MX family of applications processors provides this capability</span><br><span class="line">with the High Availability Boot (HAB) component of the on-chip ROM.</span><br><span class="line">The ROM is responsible for loading the initial program image from the boot medium.</span><br><span class="line">HAB enables the ROM to authenticate the program image by using digital signatures.</span><br><span class="line">This initial program image is usually a bootloader.</span><br></pre></td></tr></table></figure><h3 id="官方术语"><a href="#官方术语" class="headerlink" title="官方术语"></a>官方术语</h3><ul><li><code>CA(Certificate Authority)</code>：持有<code>private key</code>并对<code>public key</code>签名生成<code>数字证书</code>；</li><li><code>CAAM(Cryptographic Acceleration and Assurance Module)</code>：用于加密，流密码和散列算法的加速器，使用随机数生成器和运行时完整性检查程序；</li><li><code>CSF(Command Sequence File)</code>：由HAB解释的二进制数据结构，用于指导身份验证操作；</li><li><code>CST(Code Signing Tool)</code>：在构建主机上运行的应用程序，用于生成<code>CSF</code>和相关的数字签名，产生NXP所需要的<code>SRK</code>等；</li><li><code>HAB(High Assurance Boot)</code>：启动时在NXP处理器的内部ROM中执行的软件库，通过<code>CSF</code>验证数字签名来验证外部存储器中的软件；</li><li><code>OTP(One-Time Programmable)</code>：OTP硬件包括屏蔽ROM和电可编程保险丝（eFuse），只能烧写一次，不可改变；</li><li><code>PKI(Public Key Infrastructure)</code>：公钥证书的层次结构，其中每个证书（根证书除外）都可以使用其上方的公钥进行验证；</li><li><code>SRK(Super Root Key)</code>：<font clolor="red">一个RSA密钥对（SRK公钥和秘钥），它构成了启动时认证链的起点。SRK公钥的散列使用OTP硬件嵌入在处理器中。 SRK私钥由CA持有。</font></li></ul><h3 id="HAB身份验证过程"><a href="#HAB身份验证过程" class="headerlink" title="HAB身份验证过程"></a>HAB身份验证过程</h3><p>HAB身份验证基于使用RSA算法加密的<code>public key</code>，验证镜像数据，使用一系列<code>private key</code>对镜像数据在安全的环境中进行脱机签名。然后在i.MX处理器上使用相应的<code>public key</code>(SRK)验证所得到的签名镜像数据。<br><img src="https://pic.downk.cc/item/5f24e4ca14195aa594f28506.png" alt="i.MX HAB验签流程"></p><p>在上图中：<br>1、在安全的环境中对<code>SW Image</code>内容hash化生成<code>摘要A</code>，然后使用<code>private key</code>对<code>摘要A</code>进行签名（采用RSA算法），得到<code>SW Image</code>和<code>Signature</code>；<br>2、将该<code>SW Image</code>和<code>Signature</code>烧录到flash中后去启动；<br>3、在启动的时候会将<code>SW Image</code>内容hash化生成<code>摘要B</code>（如果<code>SW Image</code>没有被修改过，<code>摘要A</code>和<code>摘要B</code>肯定相等），使用Fuse中的<code>public key</code>进行对<code>Signature</code>进行验签得到<code>摘要C</code>，如果<code>摘要B</code>和<code>摘要C</code>相等，表示认证成功，就去启动OS。</p><p>注意，这里i.MX处理器中芯片存储的是<code>SRK</code>，而不是hash化后的值，所以该<code>SRK</code>可以直接进行验签。</p><hr><h2 id="HAB和AHAB"><a href="#HAB和AHAB" class="headerlink" title="HAB和AHAB"></a>HAB和AHAB</h2><p><code>HAB Library</code>是<code>boot rom code</code>中的一个子模块，<code>AHAB</code>是某些特定的NXP处理器中的安全子系统。他们负责验证作为产品软件一部分的数字签名，并确保当处理器配置为安全设备时，不允许运行未经身份验证的代码。</p><h3 id="使用HAB的启动流程"><a href="#使用HAB的启动流程" class="headerlink" title="使用HAB的启动流程"></a>使用HAB的启动流程</h3><p>对于HAB，引导加载程序映像包含引导加载程序本身以及：HAB用于验证映像的命令，<code>数字签名</code>数据和<code>public key数字证书</code>数据，统称为<code>命令序列文件（CSF）</code>数据，使用代码签名工具（CST）离线生成CSF数据。</p><p><img src="https://pic.downk.cc/item/5f26229714195aa594625cf1.png" alt="HAB流程"></p><h3 id="使用AHAB-SECO-的启动流程"><a href="#使用AHAB-SECO-的启动流程" class="headerlink" title="使用AHAB(SECO)的启动流程"></a>使用AHAB(SECO)的启动流程</h3><p><img src="https://pic.downk.cc/item/5f26229714195aa594625cf3.png" alt="AHAB流程"></p><hr><h2 id="使用CST工具进行数字签名"><a href="#使用CST工具进行数字签名" class="headerlink" title="使用CST工具进行数字签名"></a>使用CST工具进行数字签名</h2><p>可以在<a href="https://www.nxp.com/webapp/sps/download/license.jsp?colCode=IMX_CST_TOOL" target="_blank" rel="noopener">IMX_CST_TOOL</a> 下载CST工具，该工具用于对HAB和AHAB进行代码签名。</p><ul><li>CST输入文件：<br>要签名的Image镜像 + CSF文件(CSF文件提供了一系列指令给CST，比如说数据镜像从哪里开始签名，使用哪个key去签名)</li><li>CST输出文件：<br>Image镜像 + 数字签名 + CSF文件(该文件只有HAB有)。</li></ul><p><img src="https://pic.downk.cc/item/5f26229714195aa594625cf5.png" alt="cst工具"></p><h3 id="CST目录结构"><a href="#CST目录结构" class="headerlink" title="CST目录结构"></a>CST目录结构</h3><ul><li><code>ca\</code>：包含OpenSSL配置文件。 使用OpenSSL命令行工具生成签名密钥和证书时，将使用这些配置文件;</li><li><code>crts\</code>：包含用于签名的<code>public key</code>证书，最初此目录为空；</li><li><code>linux32/</code>和<code>linux64/</code>：包含CST工具执行的文件。<code>bin/cst</code>用于CST执行对代码签名；<code>bin/srktool</code>为HAB4和AHAB生成SRK表和e-fuse文件；</li><li><code>keys/</code>：包含用于签名的<code>private key</code>，最初时候此目录只包含生成<code>PKI tree</code>的脚本，格式如下：</li></ul><p>包含的脚本如下：<br><code>habx_pki_tree.sh/.bat</code>脚本，其中<code>x</code>为3或者4，该脚本有Linux和Windows两种，都是用于生成支持HABx所需要的一系列密钥和证书；<br><code>ahab_pki_tree.sh/.bat</code>脚本，该脚本有Linux和Windows两种，都是用于生成支持<code>AHAB</code>所需要的一系列密钥和证书；</p><hr><h2 id="一步步porting-security-boot"><a href="#一步步porting-security-boot" class="headerlink" title="一步步porting security boot"></a>一步步porting security boot</h2><h3 id="生成PKI-tree"><a href="#生成PKI-tree" class="headerlink" title="生成PKI tree"></a>生成<code>PKI tree</code></h3><p>主要生成<code>private key</code>和<code>public key 数字证书</code>，生成的<code>PKI tree</code>包含4个<code>SRK</code>。<br>在<code>csf文件</code>中会指定使用哪个SRK，签名后会往container中相应字段的值写入，这样的话在读取到container head之后就可以根据这个值来判断使用fuse的哪个SRK。<br>那为什么要用4个呢？通常情况下，可以让不同的批次指定不同的SRK。或者是同一个SRK永久了，可以指定换另外一个SRK。废弃掉的SRK可以在<code>csf文件</code>中使用<code>Revocations</code>来指定废弃哪个。<br><code>csf文件</code>用例如下：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[Header]</span><br><span class="line">Target = AHAB</span><br><span class="line">Version = 1.0</span><br><span class="line"></span><br><span class="line">[Install SRK]</span><br><span class="line"># SRK table generated by srktool</span><br><span class="line">File = &quot;./release/crts/SRK_1_2_3_4_table.bin&quot;</span><br><span class="line"># Public key certificate in PEM format</span><br><span class="line">Source = &quot;./release/crts/SRK1_sha384_secp384r1_v3_usr_crt.pem&quot;</span><br><span class="line"># Index of the public key certificate within the SRK table (0 .. 3)</span><br><span class="line">Source index = 0</span><br><span class="line"># Type of SRK set (NXP or OEM)</span><br><span class="line">Source set = OEM</span><br><span class="line"># bitmask of the revoked SRKs</span><br><span class="line">Revocations = 0x0</span><br><span class="line"></span><br><span class="line">[Authenticate Data]</span><br><span class="line"># Binary to be signed generated by mkimage</span><br><span class="line">File = &quot;flash_os.bin&quot;</span><br><span class="line"># Offsets = Container header  Signature block (printed out by mkimage)</span><br><span class="line">Offsets   = 0x0             0x90</span><br></pre></td></tr></table></figure><p></p><p>我对<code>SRK</code>可以理解为<code>private key</code>和<code>public key certificates</code>，前者用于对镜像进行签名或者是对<code>public key</code>进行加密生成<code>数字证书</code>。使用以下命令生成<code>PKI tree</code>。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># tar -zxvf cst-3.1.0.tgz</span><br><span class="line"># cd release/keys</span><br><span class="line"># ./ahab_pki_tree.sh</span><br></pre></td></tr></table></figure><p></p><p>生成的<code>PKI tree</code>结构如下，不带<code>SGK</code>。运行结果如下。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">   +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><br><span class="line">    This script is a part of the Code signing tools for NXP&apos;s</span><br><span class="line">    Advanced High Assurance Boot.  It generates a basic PKI tree. The</span><br><span class="line">    PKI tree consists of one or more Super Root Keys (SRK), with each</span><br><span class="line">    SRK having one subordinate keys:</span><br><span class="line">        + a Signing key (SGK)</span><br><span class="line">    Additional keys can be added to the PKI tree but a separate</span><br><span class="line">    script is available for this.  This this script assumes openssl</span><br><span class="line">    is installed on your system and is included in your search</span><br><span class="line">    path.  Finally, the private keys generated are password</span><br><span class="line">    protectedwith the password provided by the file key_pass.txt.</span><br><span class="line">    The format of the file is the password repeated twice:</span><br><span class="line">        my_password</span><br><span class="line">        my_password</span><br><span class="line">    All private keys in the PKI tree are in PKCS #8 format will be</span><br><span class="line">    protected by the same password.</span><br><span class="line"></span><br><span class="line">    +++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++</span><br><span class="line">Do you want to use an existing CA key (y/n)?: n</span><br><span class="line">Do you want to use Elliptic Curve Cryptography (y/n)?: y</span><br><span class="line">Enter length for elliptic curve to be used for PKI tree:</span><br><span class="line">Possible values p256, p384, p521:  p384</span><br><span class="line">Enter the digest algorithm to use: sha384</span><br><span class="line">Enter PKI tree duration (years): 5</span><br><span class="line">Do you want the SRK certificates to have the CA flag set? (y/n)?: n</span><br><span class="line">A default &apos;serial&apos; file was created!</span><br><span class="line">A default file &apos;key_pass.txt&apos; was created with password = test!</span><br><span class="line"></span><br><span class="line">+++++++++++++++++++++++++++++++++++++</span><br><span class="line">+ Generating CA key and certificate +</span><br><span class="line">+++++++++++++++++++++++++++++++++++++</span><br><span class="line"></span><br><span class="line">Generating a 384 bit EC private key</span><br><span class="line">writing new private key to &apos;temp_ca.pem&apos;</span><br><span class="line">-----</span><br><span class="line"></span><br><span class="line">++++++++++++++++++++++++++++++++++++++++</span><br><span class="line">+ Generating SRK key and certificate 1 +</span><br><span class="line">++++++++++++++++++++++++++++++++++++++++</span><br><span class="line"></span><br><span class="line">read EC key</span><br><span class="line">writing EC key</span><br><span class="line">Using configuration from ../ca/openssl.cnf</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">The Subject&apos;s Distinguished Name is as follows</span><br><span class="line">commonName            :ASN.1 12:&apos;SRK1_sha384_secp384r1_v3_usr&apos;</span><br><span class="line">Certificate is to be certified until Mar 24 06:47:01 2024 GMT (1825 days)</span><br><span class="line"></span><br><span class="line">Write out database with 1 new entries</span><br><span class="line">Data Base Updated</span><br><span class="line"></span><br><span class="line">++++++++++++++++++++++++++++++++++++++++</span><br><span class="line">+ Generating SRK key and certificate 2 +</span><br><span class="line">++++++++++++++++++++++++++++++++++++++++</span><br><span class="line"></span><br><span class="line">read EC key</span><br><span class="line">writing EC key</span><br><span class="line">Using configuration from ../ca/openssl.cnf</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">The Subject&apos;s Distinguished Name is as follows</span><br><span class="line">commonName            :ASN.1 12:&apos;SRK2_sha384_secp384r1_v3_usr&apos;</span><br><span class="line">Certificate is to be certified until Mar 24 06:47:01 2024 GMT (1825 days)</span><br><span class="line"></span><br><span class="line">Write out database with 1 new entries</span><br><span class="line">Data Base Updated</span><br><span class="line"></span><br><span class="line">++++++++++++++++++++++++++++++++++++++++</span><br><span class="line">+ Generating SRK key and certificate 3 +</span><br><span class="line">++++++++++++++++++++++++++++++++++++++++</span><br><span class="line"></span><br><span class="line">read EC key</span><br><span class="line">writing EC key</span><br><span class="line">Using configuration from ../ca/openssl.cnf</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">The Subject&apos;s Distinguished Name is as follows</span><br><span class="line">commonName            :ASN.1 12:&apos;SRK3_sha384_secp384r1_v3_usr&apos;</span><br><span class="line">Certificate is to be certified until Mar 24 06:47:01 2024 GMT (1825 days)</span><br><span class="line"></span><br><span class="line">Write out database with 1 new entries</span><br><span class="line">Data Base Updated</span><br><span class="line"></span><br><span class="line">++++++++++++++++++++++++++++++++++++++++</span><br><span class="line">+ Generating SRK key and certificate 4 +</span><br><span class="line">++++++++++++++++++++++++++++++++++++++++</span><br><span class="line"></span><br><span class="line">read EC key</span><br><span class="line">writing EC key</span><br><span class="line">Using configuration from ../ca/openssl.cnf</span><br><span class="line">Check that the request matches the signature</span><br><span class="line">Signature ok</span><br><span class="line">The Subject&apos;s Distinguished Name is as follows</span><br><span class="line">commonName            :ASN.1 12:&apos;SRK4_sha384_secp384r1_v3_usr&apos;</span><br><span class="line">Certificate is to be certified until Mar 24 06:47:01 2024 GMT (1825 days)</span><br><span class="line"></span><br><span class="line">Write out database with 1 new entries</span><br><span class="line">Data Base Updated</span><br></pre></td></tr></table></figure><p></p><h3 id="生成SRK-table和SRK-hash"><a href="#生成SRK-table和SRK-hash" class="headerlink" title="生成SRK table和SRK hash"></a>生成<code>SRK table</code>和<code>SRK hash</code></h3><ul><li>输入文件是在上一个步骤中创建的<code>public key certificates</code>；</li><li>输出文件是<code>SRK table</code>和<code>SRK hash</code>。</li></ul><p>通过<code>CA</code>的<code>private key</code>对<code>public key certificates</code>进行<code>解密</code>就可以拿到可以对镜像认证的<code>public key</code>。</p><p>在AHAB架构中：</p><ul><li><code>SRK table</code>就是一系列的<code>public key</code>证书，<code>SRK table</code>会打包到已签名的镜像中；</li><li><code>SRK hash</code>是<code>SRK table</code> hash化生成的<code>数字摘要</code>，会被烧写到i.MX芯片的<code>SOC SRK_HASH[511:0]</code> OTP中；</li></ul><p>在认证过程期间的目标设备上，AHAB代码(<code>SECO</code>)会将镜像中的<code>SRK table</code> hash化然后与<code>SoC SRK_HASH</code>中的<code>SRK hash</code>比较，如果相等，则说明用于验签的<code>public key</code>是正确的，AHAB代码可以用该<code>public key</code>进行后续的镜像认证。对于<code>SRK table</code>中未使用的4个密钥中的任何一个，相应的密钥位将设置为0。后续的镜像认证，就是完全按照HAB的过程来了。</p><p>为什么生成<code>SRK table</code>后还要生成<code>SRK hash</code>呢？主要原因是：</p><ul><li>由于<code>OTP</code>空间小，将<code>public key</code> hash化之后，可以减小存储空间；</li><li>为了防止<code>public key</code>和<code>private key</code>被替换。假设有个图谋不轨的人，使用<code>CST</code>生成<code>private key</code>对自己的镜像签名，然后再将<code>public key</code>加入到镜像中，镜像中的<code>public key</code>被hash化后肯定不与<code>fuse</code>中的<code>SRK hash</code>不一致，因此无法验签通过。</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># cd ../crts/</span><br><span class="line"># ../linux64/bin/srktool -a -s sha384 -t SRK_1_2_3_4_table.bin \</span><br><span class="line">-e SRK_1_2_3_4_fuse.bin -f 1 -c \</span><br><span class="line">SRK1_sha384_secp384r1_v3_usr_crt.pem,\</span><br><span class="line">SRK2_sha384_secp384r1_v3_usr_crt.pem,\</span><br><span class="line">SRK3_sha384_secp384r1_v3_usr_crt.pem,\</span><br><span class="line">SRK4_sha384_secp384r1_v3_usr_crt.pem</span><br></pre></td></tr></table></figure><p>各个参数含义如下：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">  -a, --ahab_ver:</span><br><span class="line">      AHAB Version - set for AHAB SRK table generation</span><br><span class="line"></span><br><span class="line">-s, --sign_digest &lt;digestalg&gt;:</span><br><span class="line">      Signature Digest algorithm. Either sha256, sha384 or sha512</span><br><span class="line"></span><br><span class="line">-t, --table &lt;tablefile&gt;:</span><br><span class="line">      Filename for output SRK table binary file</span><br><span class="line"></span><br><span class="line">-e, --efuses &lt;efusefile&gt;:</span><br><span class="line">      Filename for the output SRK efuse binary file containing the SRK table hash</span><br><span class="line"></span><br><span class="line">-f, --fuse_format &lt;format&gt;:</span><br><span class="line">      Optional, Data format of the SRK efuse binary file.  The</span><br><span class="line">      format may be selected by setting &lt;format&gt; to either:</span><br><span class="line">        - 0: 8 fuses per word, ex: 00 00 00 0a 00 00 00 01 ...</span><br><span class="line">        - 1 (default): 32 fuses per word, ex: 0a 01 ff 8e</span><br><span class="line"></span><br><span class="line">-c, --certs &lt;srk1&gt;,&lt;srk2&gt;,...,&lt;srk4&gt;:</span><br><span class="line">      X.509v3 certificate filenames.</span><br><span class="line">        - Certificates may be either DER or PEM encoded format</span><br><span class="line">        - Certificate filenames must be separated by a &apos;,&apos;with no spaces</span><br><span class="line">        - A maximum of 4 certificate filenames may be provided. Additional</span><br><span class="line">          certificate names are ignored</span><br></pre></td></tr></table></figure><p></p><p>用户可以使用如下命令验证生成的<code>SRK table</code>和<code>SRK hash</code>的sha256sum是否一致。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># od -t x4 --endian=big SRK_1_2_3_4_fuse.bin</span><br><span class="line">0000000 5d46e030 479c8368 3a73a270 90584918</span><br><span class="line">0000020 30ae00fa 74f9e41b 5c99b7b6 0c6ce7a3</span><br><span class="line">0000040 782ffb59 705f0e1a ae15667a 75bddf53</span><br><span class="line">0000060 d27f2290 fc079e18 f2f38eaa 4b3baaa5</span><br><span class="line">0000100</span><br><span class="line"></span><br><span class="line"># sha512sum SRK_1_2_3_4_table.bin</span><br><span class="line">5d46e030479c83683a73a2709058491830ae00fa74f9e41b5c99b7b60c6ce7a3782ffb59705f0e1aae15667a75bddf53d27f2290fc079e18f2f38eaa4b3baaa5  SRK_1_2_3_4_table.bin</span><br></pre></td></tr></table></figure><p></p><h3 id="对镜像签名"><a href="#对镜像签名" class="headerlink" title="对镜像签名"></a>对镜像签名</h3><p>将镜像和<code>csf</code>文件拷贝到cst目录下，按照<code>csf</code>要求对镜像进行签名。其中使用<code>mkimage</code>生成flash.bin的时候会打印如下log，<code>csf_boot_image.txt</code>文件中的<code>offset</code>字段必须根据这个log的内容做相应的修改。<code>csf</code>文件用于指定从哪块区域的image去验证，使用哪个key去验证。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CST: CONTAINER 0 offset: 0x400</span><br><span class="line">CST: CONTAINER 0: Signature Block: offset is at 0x590</span><br><span class="line">DONE.</span><br><span class="line">Note: Please copy image to offset: IVT_OFFSET + IMAGE_OFFSET</span><br></pre></td></tr></table></figure><p></p><p>对镜像签名命令如下，生成<code>flash.signed.bin</code>的签名文件。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># cd ../../</span><br><span class="line"># cp -rf ~/work2/xxx/uboot-imx/flash.bin ./</span><br><span class="line"># cp -rf ~/work2/xxx/uboot-imx/doc/imx/ahab/csf_examples/csf_boot_image.txt ./</span><br><span class="line"># ./release/linux64/bin/cst -i csf_boot_image.txt -o signed-flash.bin</span><br></pre></td></tr></table></figure><p></p><h3 id="烧写SRK-fuse到soc中"><a href="#烧写SRK-fuse到soc中" class="headerlink" title="烧写SRK fuse到soc中"></a>烧写<code>SRK fuse</code>到soc中</h3><p>执行如下命令，获取到烧写fuse的值：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># od -t x4 SRK_1_2_3_4_fuse.bin</span><br><span class="line">0000000 475e1dca ec5c98d2 6dd5b7ec da535b48</span><br><span class="line">0000020 5baa6f61 9d788292 27f53d5f 1316752a</span><br><span class="line">0000040 01043451 7578275d c5fcd1e1 12bac3e2</span><br><span class="line">0000060 ef6860a2 a0a12501 bc2b9c25 cfeea329</span><br><span class="line">0000100</span><br></pre></td></tr></table></figure><p></p><p>因此，烧写fuse的值为(只针对i.MX8QXP)，可以在uboot命令行中使用<code>fuse</code>命令进行烧写。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">fuse prog 0 730 0x475e1dca</span><br><span class="line">fuse prog 0 731 0xec5c98d2</span><br><span class="line">fuse prog 0 732 0x6dd5b7ec</span><br><span class="line">fuse prog 0 733 0xda535b48</span><br><span class="line">fuse prog 0 734 0x5baa6f61</span><br><span class="line">fuse prog 0 735 0x9d788292</span><br><span class="line">fuse prog 0 736 0x27f53d5f</span><br><span class="line">fuse prog 0 737 0x1316752a</span><br><span class="line">fuse prog 0 738 0x01043451</span><br><span class="line">fuse prog 0 739 0x7578275d</span><br><span class="line">fuse prog 0 740 0xc5fcd1e1</span><br><span class="line">fuse prog 0 741 0x12bac3e2</span><br><span class="line">fuse prog 0 742 0xef6860a2</span><br><span class="line">fuse prog 0 743 0xa0a12501</span><br><span class="line">fuse prog 0 744 0xbc2b9c25</span><br><span class="line">fuse prog 0 745 0xcfeea329</span><br></pre></td></tr></table></figure><p></p><p>烧写fuse的原理如下： <a href="https://imxdev.gitlab.io/tutorial/Burning_eFuses_on_i.MX8_and_i.MX8x_families/" target="_blank" rel="noopener">https://imxdev.gitlab.io/tutorial/Burning_eFuses_on_i.MX8_and_i.MX8x_families/</a><br><img src="https://pic.downk.cc/item/5f262c0714195aa5946552e8.png" alt="fuse烧录原理"></p><h3 id="验证签名的boot镜像是否认证成功"><a href="#验证签名的boot镜像是否认证成功" class="headerlink" title="验证签名的boot镜像是否认证成功"></a>验证签名的boot镜像是否认证成功</h3><p>将第3步生成的签名镜像<code>flash.signed.bin</code>烧写到板子上，从板子启动。<br>在最新的<code>imx_v2018.03_4.14.98_2.0.0_ga</code>分支上，无需通过scu的串口来查看。直接在uboot命令行中使用<code>ahab_status</code>就可以确定是否验证成功。</p><hr><h2 id="配置SCFW支持debug-monitor"><a href="#配置SCFW支持debug-monitor" class="headerlink" title="配置SCFW支持debug monitor"></a>配置<code>SCFW</code>支持<code>debug monitor</code></h2><p>配置<code>SCFW</code>如下几个功能：</p><ul><li>如果使用板子上使用<code>AF28(SCU.UART0.RX)</code>和<code>AH30(SCU.UART0.TX)</code>做为<code>SCU</code>的串口，那么必须在<code>platform/board/mx8qx_mek/board.c</code>文件中打开<code>ALT_DEBUG_SCU_UART</code>宏，否则就是使用到M4 UART；</li><li>编译<code>scfw_tcm.bin</code>的时候使用<code>make qx B=mek V=1 R=B0 M=1 D=1 DL=2</code>命令，<code>M=1</code>表示打开<code>debug monitor</code>功能，也就是可以通过串口与<code>SCFW</code>交互，<code>D=1</code>表示打开debug功能，<code>DL=2</code>表示debug level。</li></ul><p>详细的可以参考[System Controller Firmware Porting Guide.pdf]和[sc_fw_port.pdf]下面的<code>debug monitor</code>的功能：</p><hr><h2 id="OS镜像签名"><a href="#OS镜像签名" class="headerlink" title="OS镜像签名"></a>OS镜像签名</h2><p>将kernel编译出来的<code>Image</code>和<code>.dtb</code>文件拷贝到<code>imx-mkimage</code>环境中，这个可以从 <a href="https://source.codeaurora.org/external/imx/imx-mkimage/" target="_blank" rel="noopener">imx-mkimage</a> 下载。假定目前处于<code>imx-mkimage</code>环境下。</p><p>1、拷贝所需要的镜像和dtb<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># cp -rf ~/work2/xxx/kernel-imx/arch/arm64/boot/Image ./iMX8QX/</span><br><span class="line"># cp -rf ~/work2/xxx/kernel-imx/arch/arm64/boot/boot/dts/freescale/xxxxx.dtb ./iMX8QX/</span><br></pre></td></tr></table></figure><p></p><p>2、修改<code>soc.mk</code>为：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">flash_linux flash_b0_linux: $(MKIMG) Image xxxxx.dtb</span><br><span class="line">    ./$(MKIMG) -soc QX -rev B0 -c -ap Image a35 0x80280000 --data xxxxx.dtb 0x83000000 -out flash_os.bin</span><br></pre></td></tr></table></figure><p></p><p>3、编译生成OS镜像的flash_os.bin 镜像拷贝到<code>cst</code>目录下。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># make SOC=iMX8QX flash_linux</span><br><span class="line"># mv i.MX8QX/flash_os.bin ~/work2/xxx/cst/</span><br></pre></td></tr></table></figure><p></p><p>4、拷贝OS镜像签名所需的csf文件<code>csf_linux_img.txt</code></p><p>5、修改<code>csf_linux_img.txt</code>文件中的<code>offset</code>字段。</p><p>6、在<code>cst</code>目录下对<code>flash_os.bin</code>进行签名：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># ./release/linux64/bin/cst -i csf_linux_img.txt -o os_cntr_signed.bin</span><br></pre></td></tr></table></figure><p></p><hr><h2 id="SPL-Secondary-Program-Loader-的特殊处理"><a href="#SPL-Secondary-Program-Loader-的特殊处理" class="headerlink" title="SPL(Secondary Program Loader)的特殊处理"></a>SPL(Secondary Program Loader)的特殊处理</h2><p>SPL被用于在初始化ARM ATF和u-boot之前初始化引导程序。u-boot中支持AHAB功能，这个功能对于完全验证flash.bin至关重要。<br>在SPL目标上，只有SCFW,SPL,M4镜像在SCU ROM阶段验证。为了验证ATF和U-boot，必须在SPL阶段调用<code>sc_misc_seco_authenticate()</code>进行验证。</p><h3 id="包含SPL的启动镜像"><a href="#包含SPL的启动镜像" class="headerlink" title="包含SPL的启动镜像"></a>包含SPL的启动镜像</h3><p>包含SPL的镜像包含3个container，如下：</p><ul><li>第1个container只包含SECO FW，NXP签名，在SCU ROM阶段使用SECO ROM验证；</li><li>第2个container包含SCFW，SPL，M4镜像，这些由OEM签名，在SCU ROM阶段使用SECO FW验证；</li><li>第3个container包含u-boot和ATF，SPL负责load这个container，和使用接口通过SCU发送命令给SECO FW对container进行验证；<br><img src="https://pic.downk.cc/item/5f262cc914195aa594659daa.png" alt="带spl镜像处理"></li></ul><h3 id="对包含SPL的镜像签名"><a href="#对包含SPL的镜像签名" class="headerlink" title="对包含SPL的镜像签名"></a>对包含SPL的镜像签名</h3><p><img src="https://pic.downk.cc/item/5f263aba14195aa59469b993.png" alt="对包含SPL的镜像签名"></p><p>(1)、编译生成第3个container镜像：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make SOC=iMX8QX u-boot-atf-container.img</span><br></pre></td></tr></table></figure><p></p><p>编译的log如下：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">AP file_offset = 0x91800 size = 0x4d800</span><br><span class="line">CST: CONTAINER 0 offset: 0x0</span><br><span class="line">CST: CONTAINER 0: Signature Block: offset is at 0x190</span><br><span class="line">DONE.</span><br></pre></td></tr></table></figure><p></p><p>(2)、对第3个container签名：<br>a. 在cst中创建<code>csf_uboot_atf.txt</code>文件，内容如下：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[Header]</span><br><span class="line">Target = AHAB</span><br><span class="line">Version = 1.0</span><br><span class="line"></span><br><span class="line">[Install SRK]</span><br><span class="line"># SRK table generated by srktool</span><br><span class="line">File = &quot;./release/crts/SRK_1_2_3_4_table.bin&quot;</span><br><span class="line"># Public key certificate in PEM format</span><br><span class="line">Source = &quot;./release/crts/SRK1_sha384_secp384r1_v3_usr_crt.pem&quot;</span><br><span class="line"># Index of the public key certificate within the SRK table (0 .. 3)</span><br><span class="line">Source index = 0</span><br><span class="line"># Type of SRK set (NXP or OEM)</span><br><span class="line">Source set = OEM</span><br><span class="line"># bitmask of the revoked SRKs</span><br><span class="line">Revocations = 0x0</span><br><span class="line"></span><br><span class="line">[Authenticate Data]</span><br><span class="line"># Binary to be signed generated by mkimage</span><br><span class="line">File = &quot;u-boot-atf-container.img&quot;</span><br><span class="line"># Offsets = Container header  Signature block (printed out by mkimage)</span><br><span class="line">Offsets   = 0x0             0x190</span><br></pre></td></tr></table></figure><p>b. 对镜像进行签名</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./release/linux64/bin/cst -i csf_uboot_atf.txt -o signed-u-boot-atf-container.img</span><br></pre></td></tr></table></figure><p>将生成的<code>signed-u-boot-atf-container.img</code>拷贝到<code>imx-mkimage</code>目录中重新打包，并重命名为<code>u-boot-atf-container.img</code>。</p><p>c、编译生成<code>flash.bin</code>镜像<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make SOC=iMX8QX flash_spl_container</span><br></pre></td></tr></table></figure><p></p><p>编译的log如下：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CST: CONTAINER 0 offset: 0x400</span><br><span class="line">CST: CONTAINER 0: Signature Block: offset is at 0x510</span><br><span class="line">DONE.</span><br><span class="line">Note: Please copy image to offset: IVT_OFFSET + IMAGE_OFFSET</span><br><span class="line">append u-boot-atf-container.img at 258 KB</span><br></pre></td></tr></table></figure><p></p><p>d、对<code>flash.bin</code>镜像签名<br>将生成的<code>flash.bin</code>镜像拷贝到cst目录中签名。<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./release/linux64/bin/cst -i csf_boot_image.txt -o signed-flash.bin</span><br></pre></td></tr></table></figure><p></p><h3 id="带SPL和不带SPL签名的差异"><a href="#带SPL和不带SPL签名的差异" class="headerlink" title="带SPL和不带SPL签名的差异"></a>带SPL和不带SPL签名的差异</h3><ul><li>带SPL的镜像总共有3个container，不带SPL只有2个container；</li><li>带SPL的镜像需要将第3个container(u-boot + ATF)先签名，然后将签名后的镜像再跟第2个container(SCFW，SPL，M4镜像)打包再一起再进行签名最终生成<code>flash.bin</code>镜像。</li></ul><hr><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="http://variwiki.com/index.php?title=High_Assurance_Boot" target="_blank" rel="noopener">i.MX High Assurance Boot (HAB) / Secure Boot</a><br><a href="https://source.codeaurora.org/external/imx/uboot-imx/tree/doc/imx/ahab/guides/mx8_mx8x_secure_boot.txt?h=imx_v2018.03_4.14.98_2.0.0_ga" target="_blank" rel="noopener">mx8_mx8x_secure_boot.txt</a><br><a href="https://source.codeaurora.org/external/imx/uboot-imx/tree/doc/imx/ahab/guides/mx8_mx8x_spl_secure_boot.txt?h=imx_v2018.03_4.14.98_2.0.0_ga" target="_blank" rel="noopener">mx8_mx8x_spl_secure_boot.txt</a><br><a href="https://source.codeaurora.org/external/imx/uboot-imx/tree/doc/imx/ahab/introduction_ahab.txt?h=imx_v2018.03_4.14.98_2.0.0_ga" target="_blank" rel="noopener">introduction_ahab.txt</a>：<br><a href="https://source.codeaurora.org/external/imxsupport/imx_sec_apps/about/" target="_blank" rel="noopener">CAAM测试程序</a><br><a href="https://blog.quarkslab.com/vulnerabilities-in-high-assurance-boot-of-nxp-imx-microprocessors.html" target="_blank" rel="noopener">i.MX HAB介绍</a><br><a href="https://blog.quarkslab.com/vulnerabilities-in-high-assurance-boot-of-nxp-imx-microprocessors.html" target="_blank" rel="noopener">High Assurance Boot (HAB) for dummies</a></p></div><div><div class="my_post_copyright"><script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script><script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script><script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script><p><span>Title:</span><a href="/258082eb/">i.MX8 AHAB secure boot porting guide</a></p><p><span>Author:</span><a href="/" title="Visit Victor Huang blog">Victor Huang</a></p><p><span>Time:</span>2020-08-02 / 12:08</p><p><span>Link:</span><a href="/258082eb/" title="i.MX8 AHAB secure boot porting guide">http://wowothink.com/258082eb/</a> <span class="copy-path" title="click to copy link"><i class="fa fa-clipboard" data-clipboard-text="http://wowothink.com/258082eb/" aria-label="copy link success"></i></span></p><p><span>License:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)</a></p></div><script>var clipboard=new Clipboard(".fa-clipboard");$(".fa-clipboard").click(function(){clipboard.on("success",function(){swal({title:"",text:"copy link success",icon:"success",showConfirmButton:!0})})})</script></div><footer class="post-footer"><div class="post-tags"><a href="/tags/security-i-MX/" rel="tag"><i class="fa fa-tag"></i> security i.MX</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/63d41710/" rel="next" title="secure boot基本概念"><i class="fa fa-chevron-left"></i> secure boot基本概念</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/53edc8bf/" rel="prev" title="QNX800 virtual machine">QNX800 virtual machine <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/boy2.jpg" alt="Victor Huang"><p class="site-author-name" itemprop="name">Victor Huang</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">85</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">21</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">20</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:hsq_encourage@163.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/encourage2011" target="_blank" title="CSDN博客"><i class="fa fa-fw fa-crosshairs"></i>CSDN博客</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#背景"><span class="nav-number">1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NXP-AHAB介绍（i-MX8使用）"><span class="nav-number">2.</span> <span class="nav-text">NXP AHAB介绍（i.MX8使用）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NXP-HAB介绍（i-MX7以下的使用）"><span class="nav-number">3.</span> <span class="nav-text">NXP HAB介绍（i.MX7以下的使用）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#官方定义"><span class="nav-number">3.1.</span> <span class="nav-text">官方定义</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#官方术语"><span class="nav-number">3.2.</span> <span class="nav-text">官方术语</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#HAB身份验证过程"><span class="nav-number">3.3.</span> <span class="nav-text">HAB身份验证过程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HAB和AHAB"><span class="nav-number">4.</span> <span class="nav-text">HAB和AHAB</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#使用HAB的启动流程"><span class="nav-number">4.1.</span> <span class="nav-text">使用HAB的启动流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#使用AHAB-SECO-的启动流程"><span class="nav-number">4.2.</span> <span class="nav-text">使用AHAB(SECO)的启动流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用CST工具进行数字签名"><span class="nav-number">5.</span> <span class="nav-text">使用CST工具进行数字签名</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#CST目录结构"><span class="nav-number">5.1.</span> <span class="nav-text">CST目录结构</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#一步步porting-security-boot"><span class="nav-number">6.</span> <span class="nav-text">一步步porting security boot</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#生成PKI-tree"><span class="nav-number">6.1.</span> <span class="nav-text">生成PKI tree</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生成SRK-table和SRK-hash"><span class="nav-number">6.2.</span> <span class="nav-text">生成SRK table和SRK hash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对镜像签名"><span class="nav-number">6.3.</span> <span class="nav-text">对镜像签名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#烧写SRK-fuse到soc中"><span class="nav-number">6.4.</span> <span class="nav-text">烧写SRK fuse到soc中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#验证签名的boot镜像是否认证成功"><span class="nav-number">6.5.</span> <span class="nav-text">验证签名的boot镜像是否认证成功</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#配置SCFW支持debug-monitor"><span class="nav-number">7.</span> <span class="nav-text">配置SCFW支持debug monitor</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#OS镜像签名"><span class="nav-number">8.</span> <span class="nav-text">OS镜像签名</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SPL-Secondary-Program-Loader-的特殊处理"><span class="nav-number">9.</span> <span class="nav-text">SPL(Secondary Program Loader)的特殊处理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#包含SPL的启动镜像"><span class="nav-number">9.1.</span> <span class="nav-text">包含SPL的启动镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#对包含SPL的镜像签名"><span class="nav-number">9.2.</span> <span class="nav-text">对包含SPL的镜像签名</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#带SPL和不带SPL签名的差异"><span class="nav-number">9.3.</span> <span class="nav-text">带SPL和不带SPL签名的差异</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">10.</span> <span class="nav-text">参考资料</span></a></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div><script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script><script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script><div class="widget-wrap"><div id="myCanvasContainer" class="widget tagcloud"><canvas width="200" height="200" id="resCanvas"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android编译相关/">Android编译相关</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-Kernel/">Linux Kernel</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-Kernel优化/">Linux Kernel优化</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-USB/">Linux USB</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-driver/">Linux driver</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-性能测试/">Linux 性能测试</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python脚本/">Python脚本</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/QNX/">QNX</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eMMC/">eMMC</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/i-MX6/">i.MX6</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/i-MX8/">i.MX8</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security/">security</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security-i-MX/">security i.MX</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/u-boot/">u-boot</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu工具/">ubuntu工具</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/在家学习嵌入式/">在家学习嵌入式</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/备忘记录/">备忘记录</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/碰到的问题/">碰到的问题</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网站记录/">网站记录</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/调试工具/">调试工具</a><span class="tag-list-count">2</span></li></ul></canvas></div></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Victor Huang</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">113.2k</span></div></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="./public/search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script type="text/javascript" src="/js/src/clipboard.js"></script><script type="text/javascript" src="/js/src/clipboard-use.js"></script></body></html><!-- rebuild by neat -->
<!-- build time:Wed Jul 03 2019 22:36:43 GMT+0800 (中国标准时间) --><!DOCTYPE html><html class="theme-next pisces use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="eMMC,"><meta name="description" content="信息安全信息安全的三个基本目标是机密性，完整性和可用性。机密性意味着只有授权实体才能阅读和理解保密的信息。没有访问权限的其他人无法阅读或理解机密信息；完整性意味着能够确保信息受到保护，以防止未经授权的更改，修改或删除。信息的完整性包括使用识别和认证等方法的起源，完整性和正确性；可用性意味着信息始终可供授权用户使用。比如说，eMMC的Write protect(写保护)是为了保证数据的可用性。RPM"><meta name="keywords" content="eMMC"><meta property="og:type" content="article"><meta property="og:title" content="RPMB介绍与使用"><meta property="og:url" content="http://wowothink.com/8ca78fd8/index.html"><meta property="og:site_name" content="wowothink"><meta property="og:description" content="信息安全信息安全的三个基本目标是机密性，完整性和可用性。机密性意味着只有授权实体才能阅读和理解保密的信息。没有访问权限的其他人无法阅读或理解机密信息；完整性意味着能够确保信息受到保护，以防止未经授权的更改，修改或删除。信息的完整性包括使用识别和认证等方法的起源，完整性和正确性；可用性意味着信息始终可供授权用户使用。比如说，eMMC的Write protect(写保护)是为了保证数据的可用性。RPM"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://ae01.alicdn.com/kf/HTB13bxccoCF3KVjSZJn762nHFXaI.png"><meta property="og:image" content="https://ae01.alicdn.com/kf/HTB1rmxccliE3KVjSZFM762QhVXat.png"><meta property="og:image" content="https://ae01.alicdn.com/kf/HTB1xZ4bcf1H3KVjSZFH762KppXa7.png"><meta property="og:image" content="https://ae01.alicdn.com/kf/HTB16tdccoCF3KVjSZJn762nHFXaJ.png"><meta property="og:image" content="https://ae01.alicdn.com/kf/HTB11zBdck5E3KVjSZFC762uzXXaO.png"><meta property="og:image" content="https://ae01.alicdn.com/kf/HTB1s5FeclGE3KVjSZFh763kaFXaU.png"><meta property="og:updated_time" content="2019-06-09T10:08:22.803Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="RPMB介绍与使用"><meta name="twitter:description" content="信息安全信息安全的三个基本目标是机密性，完整性和可用性。机密性意味着只有授权实体才能阅读和理解保密的信息。没有访问权限的其他人无法阅读或理解机密信息；完整性意味着能够确保信息受到保护，以防止未经授权的更改，修改或删除。信息的完整性包括使用识别和认证等方法的起源，完整性和正确性；可用性意味着信息始终可供授权用户使用。比如说，eMMC的Write protect(写保护)是为了保证数据的可用性。RPM"><meta name="twitter:image" content="https://ae01.alicdn.com/kf/HTB13bxccoCF3KVjSZJn762nHFXaI.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"5.1.4",sidebar:{position:"right",display:"post",offset:12,b2t:!0,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://wowothink.com/8ca78fd8/"><title>RPMB介绍与使用 | wowothink</title></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-right page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">wowothink</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">thinking all the time</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-folder"></i><br>归档</a></li><li class="menu-item menu-item-邮件"><a href="mailto:hsq_encourage@163.com" rel="section"><i class="menu-item-icon fa fa-fw fa-envelope"></i><br>邮件</a></li><li class="menu-item menu-item-博客"><a href="https://blog.csdn.net/encourage2011" rel="section"><i class="menu-item-icon fa fa-fw fa-crosshairs"></i><br>博客</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://wowothink.com/8ca78fd8/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor Huang"><meta itemprop="description" content=""><meta itemprop="image" content="https://pic.superbed.cn/item/5c84e39e3a213b04179c44fd"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="wowothink"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">RPMB介绍与使用</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-06-09T15:10:53+08:00">2019-06-09 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/eMMC/" itemprop="url" rel="index"><span itemprop="name">eMMC</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">2,855 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">12</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="信息安全"><a href="#信息安全" class="headerlink" title="信息安全"></a>信息安全</h2><p>信息安全的三个基本目标是<code>机密性</code>，<code>完整性</code>和<code>可用性</code>。</p><ul><li><code>机密性</code>意味着只有授权实体才能阅读和理解保密的信息。没有访问权限的其他人无法阅读或理解机密信息；</li><li><code>完整性</code>意味着能够确保信息受到保护，以防止未经授权的更改，修改或删除。信息的完整性包括使用识别和认证等方法的起源，完整性和正确性；</li><li><code>可用性</code>意味着信息始终可供授权用户使用。</li></ul><p>比如说，eMMC的<code>Write protect(写保护)</code>是为了保证数据的可用性。<code>RPMB</code>是为了保证数据的<code>机密性</code>和<code>完整性</code>。eMMC关于安全特性的保护经历了：<code>Password Lock</code> -&gt; <code>Write Protect</code> -&gt; <code>RPMB</code>。<a id="more"></a><br>1、<code>Password Lock</code></p><blockquote><p>Password lock was the first security feature integrated into the eMMC spec; previously it had been implemented in legacy SD cards. The password lock feature is designed to protect the contents of the user area from any type of access (read, write, or erase).</p></blockquote><p><code>password lock&amp;unlock</code>机制使用<code>CMD42</code>命令来实现，如果设备lock住后，host只能做复位、初始化、选择和查询状态的动作，<strong>不能访问用户空间的任何数据。</strong>但是host可以访问boot分区、RPMB分区、GPA分区的信息。这个机制能保护数据不被破坏和访问，但是连同数据的所有者也不能访问。</p><p>2、<code>Write Protect</code></p><blockquote><p>Write protect was designed to protect against data corruption or erasure (whether malicious or unintentional). Once write protect is set, a host can’t erase or write to the specified protected area. However, unlike password lock, data can still be read from this area.</p></blockquote><p>这个机制用来进行<code>写保护</code>。</p><hr><h2 id="RPMB简介"><a href="#RPMB简介" class="headerlink" title="RPMB简介"></a>RPMB简介</h2><p><code>RPMB</code>是<code>Replay Protected Memory Block(重放保护内存块)</code>的简称，是eMMC中的一个具有安全特性的分区。此功能使设备能够将数据存储在经过身份验证并防止重放攻击的小型特定区域(通常是4M Bytes)中。这里涉及一个概念<code>Replay Attack</code>和<code>Replay Protected</code>。<br>1、<code>Replay Attack(重放攻击)</code><br>A向B请求服务(比如说登录某个网站)，A将密码hash化传给B。但是在这中间，E抓取到该hash值。此后，E冒充A向B发送同样的hash值来获取服务。<br><img src="https://ae01.alicdn.com/kf/HTB13bxccoCF3KVjSZJn762nHFXaI.png" alt="图1"></p><p>2、<code>Replay Protected(重放保护)</code></p><ul><li><strong>加随机数</strong>。该方法优点是认证双方不需要时间同步，双方记住使用过的随机数，如发现报文中有以前使用过的随机数，就认为是重放攻击。缺点是需要额外保存使用过的随机数，若记录的时间段较长，则保存和查询的开销较大。</li><li><strong>加时间戳</strong>。该方法优点是不用额外保存其他信息。缺点是认证双方需要准确的时间同步，同步越好，受攻击的可能性就越小。但当系统很庞大，跨越的区域较广时，要做到精确的时间同步并不是很容易。</li><li><strong>加流水号</strong>。就是双方在报文中添加一个逐步递增的整数，只要接收到一个不连续的流水号报文(太大或太小)，就认定有重放威胁。该方法优点是不需要时间同步，保存的信息量比随机数方式小。缺点是一旦攻击者对报文解密成功，就可以获得流水号，从而每次将流水号递增欺骗认证端。</li><li><strong>一次性口令</strong>。</li></ul><hr><h2 id="RPMB认证"><a href="#RPMB认证" class="headerlink" title="RPMB认证"></a>RPMB认证</h2><p>RPMB使用对称秘钥身份认证，也就是host和device使用相同的身份验证秘钥，此秘钥称之为<code>认证秘钥(AuthKey)</code>也可称为<code>RPMB Key</code>，工作方式如下：</p><ul><li>AuthKey通过host写入到eMMC中(在安全的环境中写入)的OTP区域中；</li><li>host和device在读写RPMB区域的时候需要签名和验证；</li><li>对消息进行签名涉及消息身份验证代码<code>(Message Authentication Code)MAC</code>，MAC是hash值，MAC是由通过AuthKey对<code>Message + Write Counter</code>使用HMAC SHA-256算法签名后得到。</li><li>发送的消息为<code>MAC + Message + Write Counter</code>。</li></ul><p><code>HMAC</code>是密钥相关的哈希运算消息认证码，HMAC运算利用哈希算法，以一个密钥和一个消息为输入，生成一个消息摘要作为输出。<br>保护RPMB数据的关键就是保护AuthKey，因此在读写RPMB的时候，需要在TEE的环境中，因为在访问RPMB，需要显式的使用AuthKey（如果不在TEE环境中，可以对AuthKey进行加密，然后使用解密模块去操作）。<br>另外，AuthKey最好也是独一无二的，也就是与Soc UID相关的，形成自己独一无二的Key。</p><hr><h2 id="RPMB是怎么实现重放保护"><a href="#RPMB是怎么实现重放保护" class="headerlink" title="RPMB是怎么实现重放保护"></a>RPMB是怎么实现重放保护</h2><p>重放保护最基本的就是要保证每个消息是独一无二的，RPMB分别加入2个因子进去：</p><ul><li>在写操作的时候，使用<code>Write Counter(32Bytes)</code>来实现重放保护。Write Counter是由Device管理的，该计数器在每次<strong>有效的验证写入</strong>消息后递增，其新值将包含在要发送的下一个身份验证代码<code>MAC</code>的计算中；</li><li>在读操作的时候，使用随机数<code>Nonce(16Bytes)</code>来实现重放保护。Nonce是由Host产生。<br><img src="https://ae01.alicdn.com/kf/HTB1rmxccliE3KVjSZFM762QhVXat.png" alt="图2"><br>一个访问RPMB命令通过HMAC SHA-256计算进行验证，以下几项做为该计算的输入：</li><li>身份验证的秘钥<code>AuthKey</code>；</li><li><code>消息</code>，包括命令或返回的值；</li><li><code>写计数器</code>，也就是总的写RPMB的次数，存放计数器的值为32bit，当写入次数达到0xFFFFFFFF的时候，RPMB就变为只读；</li><li><code>一个随机数</code>，它是为每个read命令随机生成的数字(Read的时候才用到)。<br>具体的RPMB命令格式如下：<br><img src="https://ae01.alicdn.com/kf/HTB1xZ4bcf1H3KVjSZFH762KppXa7.png" alt="图3"></li></ul><hr><h2 id="从RPMB读数据"><a href="#从RPMB读数据" class="headerlink" title="从RPMB读数据"></a>从RPMB读数据</h2><p><img src="https://ae01.alicdn.com/kf/HTB16tdccoCF3KVjSZJn762nHFXaJ.png" alt="图4"></p><p>1、在Host端，发送读请求以及一个16Bytes随机数Nonce给Device端；<br>2、在Device端(eMMC)，将请求的数据从RPMB取出来，通过AuthKey对<code>Data + 随机数</code>使用HMAC SHA-256算法签名后得到MAC，与<code>Data + 随机数</code>一起发送给Host端；<br>3、在Host端收到Devcie发送过来的数据， 首先比较随机数是否与自己一致，如果一致，在Host端使用自己的AuthKey对接收到的Data + 随机数使用HMAC SHA-256算法签名后得到MAC1，比较自己生成的MAC1与接收到的MAC是否一致。<br>如果一致，Host端就可以确定该Data是从RPMB读取到的，没有被修改过，而不是攻击者伪造的数据。</p><hr><h2 id="写数据到RPMB"><a href="#写数据到RPMB" class="headerlink" title="写数据到RPMB"></a>写数据到RPMB</h2><p><img src="https://ae01.alicdn.com/kf/HTB11zBdck5E3KVjSZFC762uzXXaO.png" alt="图5"></p><p>在 Host Soc端：<br>1、Host端使用AuthKey对<code>Message(Data + Metadata) + Write Counter</code> 使用HMAC SHA-256算法签名后得到MAC；<br>2、Host端将MAC + Message + Write Counter传给Device。<br>这里有个疑问，既然Write Counter是由Device管理的，那么Host怎么拿到这个值呢？</p><p><img src="https://ae01.alicdn.com/kf/HTB1s5FeclGE3KVjSZFh763kaFXaU.png" alt="图6"></p><p>从上图可以明显的看出，Host端发送<code>读Write Counter</code>和<code>随机数</code>给device端获取<code>Write Counter</code>，使用上面的读数据流程。</p><p>在Devices端(eMMC/UFS)：<br>1、Device接受到Host传送过来的MAC + Message + Write Counter；<br>2、Device端比较接收到的Write Counter是否与自己的一致；<br>2、Devices将接受到的Message + Write Counter + devcies端的AuthKey 经过SHA-256生成MAC1；<br>3、将Devices端生成的MAC1与接收到的MAC进行比较，如果两者一致，就将Data写入到RPMB中；</p><p>在这个过程中，如果想要破解，Host端需要知道AuthKey和Write Counter。当然，Write Counter可以读取出来，所以最最重要的就是保护AuthKey。</p><hr><h2 id="使用mmc命令访问RPMB"><a href="#使用mmc命令访问RPMB" class="headerlink" title="使用mmc命令访问RPMB"></a>使用<code>mmc</code>命令访问RPMB</h2><p>使用<code>mmc</code>命令可以访问RPMB，查看访问RPMB相关的用法如下：<br></p><figure class="highlight bash"><figcaption><span>mmc的使用方法</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">mmc rpmb write-key &lt;rpmb device&gt; &lt;key file&gt;</span><br><span class="line">        Program authentication key <span class="built_in">which</span> is 32 bytes length and stored</span><br><span class="line">        <span class="keyword">in</span> the specified file. Also you can specify <span class="string">'-'</span> instead of</span><br><span class="line">        key file path to <span class="built_in">read</span> the key from stdin.</span><br><span class="line">        NOTE!  This is a one-time programmable (unreversible) change.</span><br><span class="line">        Example:</span><br><span class="line">          $ <span class="built_in">echo</span> -n AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHH | \</span><br><span class="line">            mmc rpmb write-key /dev/mmcblk0rpmb -</span><br><span class="line">mmc rpmb <span class="built_in">read</span>-counter &lt;rpmb device&gt;</span><br><span class="line">        Counter value <span class="keyword">for</span> the &lt;rpmb device&gt; will be <span class="built_in">read</span> to stdout.</span><br><span class="line">mmc rpmb <span class="built_in">read</span>-block &lt;rpmb device&gt; &lt;address&gt; &lt;blocks count&gt; &lt;output file&gt; [key file]</span><br><span class="line">        Blocks of 256 bytes will be <span class="built_in">read</span> from &lt;rpmb device&gt; to output</span><br><span class="line">        file or stdout <span class="keyword">if</span> <span class="string">'-'</span> is specified. If key is specified - <span class="built_in">read</span></span><br><span class="line">        data will be verified. Instead of regular path you can specify</span><br><span class="line">        <span class="string">'-'</span> to <span class="built_in">read</span> key from stdin.</span><br><span class="line">        Example:</span><br><span class="line">          $ <span class="built_in">echo</span> -n AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHH | \</span><br><span class="line">            mmc rpmb <span class="built_in">read</span>-block /dev/mmcblk0rpmb 0x02 2 /tmp/block -</span><br><span class="line">        or <span class="built_in">read</span> two blocks without verification</span><br><span class="line">          $ mmc rpmb <span class="built_in">read</span>-block /dev/mmcblk0rpmb 0x02 2 /tmp/block</span><br><span class="line">mmc rpmb write-block &lt;rpmb device&gt; &lt;address&gt; &lt;256 byte data file&gt; &lt;key file&gt;</span><br><span class="line">        Block of 256 bytes will be written from data file to</span><br><span class="line">        &lt;rpmb device&gt;. Also you can specify <span class="string">'-'</span> instead of key</span><br><span class="line">        file path or data file to <span class="built_in">read</span> the data from stdin.</span><br><span class="line">        Example:</span><br><span class="line">          $ (awk <span class="string">'BEGIN &#123;while (c++&lt;256) printf "a"&#125;'</span> | \</span><br><span class="line">            <span class="built_in">echo</span> -n AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHH) | \</span><br><span class="line">            mmc rpmb write-block /dev/mmcblk0rpmb 0x02 - -</span><br></pre></td></tr></table></figure><p></p><p>接下来我们要做如下几件事：<br>1、创建AuthKey和WrongAuthKey：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;AAAABBBBCCCCDDDDEEEEFFFFGGGGHHHH&quot; &gt; AuthKey</span><br><span class="line">echo &quot;11112222333344445555666677778888&quot; &gt; WrongAuthKey</span><br></pre></td></tr></table></figure><p></p><p>2、将AuthKey写入到eMMC的OTP中：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmc rpmb write-key /dev/block/mmcblk0rpmb AuthKey</span><br></pre></td></tr></table></figure><p></p><p>3、创建一个256Bytes的数据：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;123456789abcdef.123456789abcdef.123456789abcdef.123456789abcdef.123456789abcdef.123456789abcdef.123456789abcdef.123456789abcdef.123456789abcdef.123456789abcdef.123456789abcdef.123456789abcdef.123456789abcdef.123456789abcdef.123456789abcdef.123456789abcdef.&quot; &gt; Data</span><br></pre></td></tr></table></figure><p></p><p>之所以要创建256Bytes的数据，是因为<code>mmc</code>规定要写256Bytes：<code>mmc rpmb write-block &lt;rpmb device&gt; &lt;address&gt; &lt;256 byte data file&gt; &lt;key file&gt;</code><br>4、用正确的AuthKey往RPMB写入数据：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmc rpmb write-block /dev/block/mmcblk0rpmb 0 Data AuthKey</span><br></pre></td></tr></table></figure><p></p><p>在这个步骤中，没有看到有读取<code>Write Counter</code>的动作，这是因为<code>mmc</code>命令已经在<code>write-block</code>中首先实现了读取<code>Write Counter</code>，详见mmc源码<code>do_rpmb_write_block()</code>函数，该函数会调用<code>rpmb_read_counter()</code>获取<code>Write Counter</code>。<br>5、用错误的AuthKey往RPMB写入数据：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmc rpmb write-block /dev/block/mmcblk0rpmb 0 Data WrongAuthKey</span><br></pre></td></tr></table></figure><p></p><p>这时候会提示<code>RPMB operation failed, retcode 0x0002</code>的错误，表示验证失败。<br>6、不用AuthKey读取RPMB数据：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmc rpmb read-block /dev/block/mmcblk0rpmb 0 1 out.txt</span><br></pre></td></tr></table></figure><p></p><p><font color="red">这个结果能读取到数据，但是并不能保证这个数据没有被修改过。</font><br>7、用正确的AuthKey读取RPMB数据：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmc rpmb read-block /dev/block/mmcblk0rpmb 0 1 out1.txt AuthKey</span><br></pre></td></tr></table></figure><p></p><p>这个结果能读取到数据，并且能保证这个数据没有被修改过，而不是攻击者伪造的数据。<br>8、用错误的AuthKey读取RPMB数据：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mmc rpmb read-block /dev/block/mmcblk0rpmb 0 1 out2.txt WrongAuthKey</span><br></pre></td></tr></table></figure><p></p><p>提示<code>RPMB MAC missmatch</code>的错误，无法读取到数据。</p><p>上面所做的所有操作，必须在可信任的环境下执行，也就是<code>TEE</code>环境，保护AuthKey不被泄露。</p><hr><h2 id="RPMB的使用用例"><a href="#RPMB的使用用例" class="headerlink" title="RPMB的使用用例"></a>RPMB的使用用例</h2><p>1、软件版本认证，防止回滚攻击<br>比如说厂商发布更新软件版本的顺序为 Ver001 -&gt; Ver002 -&gt; Ver003 -&gt; Ver004 -&gt; Ver005 -&gt; Ver006 -&gt; ……<br>有一天厂商发现Ver006有个重大的漏洞，因此他们发布和升级了Ver007版本。<br>如果不做版本认证，黑客就有可能在Ver007的版本基础上<code>回滚</code>到Ver006，并使用Ver006的漏洞进行攻击。<br>那么如果将每次升级的软件版本号写入到RPMB中，只能往更高的版本升级。因为RPMB写操作需要key，所以黑客不容易修改RPMB中的版本号来实现回滚。</p><p>2、手机开锁认证<br>通常，PIN码、图像、指纹可以给设备解锁，Android称之为<code>GateKeeper</code>，它够安全地限制对用户凭据进行暴力破解的尝试次数。其实现失败计数器，然后再验证用户密码。如果密码验证成功，则应清除失败计数器。<br>失败计数器写入到RPMB中，可以防止黑客无限制次数的攻击。</p><hr><h2 id="RPMB总结"><a href="#RPMB总结" class="headerlink" title="RPMB总结"></a>RPMB总结</h2><p>1、由于RPMB的读操作没有AuthKey也能返回的，因此，存入RPMB的数据最好是经过加密的；<br>2、RPMB的操作最好在TEE环境下，这样可以保证AuthKey不被泄露；</p><hr><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://documents.westerndigital.com/content/dam/doc-library/en_us/assets/public/western-digital/collateral/white-paper/white-paper-emmc-security.pdf" target="_blank" rel="noopener">white-paper-emmc-security</a><br><a href="https://en.wikipedia.org/wiki/Replay_attack" target="_blank" rel="noopener">Replay_attack</a><br><a href="https://linux.codingbelief.com/zh/storage/flash_memory/emmc/emmc_bus_protocol.html" target="_blank" rel="noopener">eMMC总线协议</a><br><a href="https://man.cx/mmc(1" target="_blank" rel="noopener">mmc用法</a><br><a href="https://security.stackexchange.com/questions/166182/how-to-access-replay-protected-memory-block-rpmb-in-emmc/178340" target="_blank" rel="noopener">How to access Replay Protected Memory Block (RPMB) in eMMC?</a><br><a href="https://www.jedec.org/sites/default/files/docs/JESD84-B50.pdf" target="_blank" rel="noopener">JESD84-B50.1</a><br><a href="https://git.kernel.org/pub/scm/linux/kernel/git/cjb/mmc-utils.git/" target="_blank" rel="noopener">mmc-util</a><br><a href="https://source.android.com/security/authentication/gatekeeper" target="_blank" rel="noopener">GateKeeper</a></p></div><div><div class="my_post_copyright"><script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script><script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script><script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script><p><span>Title:</span><a href="/8ca78fd8/">RPMB介绍与使用</a></p><p><span>Author:</span><a href="/" title="Visit Victor Huang blog">Victor Huang</a></p><p><span>Time:</span>2019-06-09 / 18:06</p><p><span>Link:</span><a href="/8ca78fd8/" title="RPMB介绍与使用">http://wowothink.com/8ca78fd8/</a> <span class="copy-path" title="click to copy link"><i class="fa fa-clipboard" data-clipboard-text="http://wowothink.com/8ca78fd8/" aria-label="copy link success"></i></span></p><p><span>License:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)</a></p></div><script>var clipboard=new Clipboard(".fa-clipboard");$(".fa-clipboard").click(function(){clipboard.on("success",function(){swal({title:"",text:"copy link success",icon:"success",showConfirmButton:!0})})})</script></div><footer class="post-footer"><div class="post-tags"><a href="/tags/eMMC/" rel="tag"><i class="fa fa-tag"></i> eMMC</a></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2e4a33d4/" rel="next" title="i.MX8 uuu"><i class="fa fa-chevron-left"></i> i.MX8 uuu</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/5ade33b8/" rel="prev" title="uboot fastboot原理">uboot fastboot原理 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="https://pic.superbed.cn/item/5c84e39e3a213b04179c44fd" alt="Victor Huang"><p class="site-author-name" itemprop="name">Victor Huang</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">66</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">17</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><span class="site-state-item-count">16</span> <span class="site-state-item-name">标签</span></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:hsq_encourage@163.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/encourage2011" target="_blank" title="CSDN博客"><i class="fa fa-fw fa-crosshairs"></i>CSDN博客</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#信息安全"><span class="nav-number">1.</span> <span class="nav-text">信息安全</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RPMB简介"><span class="nav-number">2.</span> <span class="nav-text">RPMB简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RPMB认证"><span class="nav-number">3.</span> <span class="nav-text">RPMB认证</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RPMB是怎么实现重放保护"><span class="nav-number">4.</span> <span class="nav-text">RPMB是怎么实现重放保护</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#从RPMB读数据"><span class="nav-number">5.</span> <span class="nav-text">从RPMB读数据</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#写数据到RPMB"><span class="nav-number">6.</span> <span class="nav-text">写数据到RPMB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#使用mmc命令访问RPMB"><span class="nav-number">7.</span> <span class="nav-text">使用mmc命令访问RPMB</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RPMB的使用用例"><span class="nav-number">8.</span> <span class="nav-text">RPMB的使用用例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#RPMB总结"><span class="nav-number">9.</span> <span class="nav-text">RPMB总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">10.</span> <span class="nav-text">参考资料</span></a></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div><script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script><script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script><div class="widget-wrap"><div id="myCanvasContainer" class="widget tagcloud"><canvas width="200" height="200" id="resCanvas"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android编译相关/">Android编译相关</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-Kernel/">Linux Kernel</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-Kernel优化/">Linux Kernel优化</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-USB/">Linux USB</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-driver/">Linux driver</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-性能测试/">Linux 性能测试</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python脚本/">Python脚本</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eMMC/">eMMC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/i-MX6/">i.MX6</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/i-MX8/">i.MX8</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/u-boot/">u-boot</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu工具/">ubuntu工具</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/备忘记录/">备忘记录</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/碰到的问题/">碰到的问题</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网站记录/">网站记录</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/调试工具/">调试工具</a><span class="tag-list-count">2</span></li></ul></canvas></div></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Victor Huang</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">75.8k</span></div><div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="./public/search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script type="text/javascript" src="/js/src/clipboard.js"></script><script type="text/javascript" src="/js/src/clipboard-use.js"></script></body></html><!-- rebuild by neat -->
<!-- build time:Mon May 04 2020 17:20:59 GMT+0800 (中国标准时间) --><!DOCTYPE html><html class="theme-next pisces use-motion" lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta name="theme-color" content="#222"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"><link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css"><link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4"><link rel="icon" type="image/png" sizes="32x32" href="/images/w2-32x32.png?v=5.1.4"><link rel="icon" type="image/png" sizes="16x16" href="/images/w2-16x16.png?v=5.1.4"><link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222"><meta name="keywords" content="Hexo, NexT"><meta name="description" content="SPL简介1、SPL是Secondary Program Loader，也就是第二阶段引导启动程序。2、SPL是一套小的boot代码，主要负责初始化外部的DRAM和flash，然后引导启动u-boot。3、SPL是在u-boot代码中，与u-boot共用一套代码，通过CONFIG_SPL_XXX来区分。u-boot可以引导kernel，那么谁来引导u-boot呢？可以使用Rom code(Boot"><meta property="og:type" content="article"><meta property="og:title" content="u-boot SPL启动流程"><meta property="og:url" content="http://wowothink.com/1e031f74/index.html"><meta property="og:site_name" content="wowothink"><meta property="og:description" content="SPL简介1、SPL是Secondary Program Loader，也就是第二阶段引导启动程序。2、SPL是一套小的boot代码，主要负责初始化外部的DRAM和flash，然后引导启动u-boot。3、SPL是在u-boot代码中，与u-boot共用一套代码，通过CONFIG_SPL_XXX来区分。u-boot可以引导kernel，那么谁来引导u-boot呢？可以使用Rom code(Boot"><meta property="og:locale" content="zh-Hans"><meta property="og:image" content="https://ae01.alicdn.com/kf/HTB1XgDda7L0gK0jSZFA763A9pXae.png"><meta property="og:updated_time" content="2019-07-21T13:33:04.220Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="u-boot SPL启动流程"><meta name="twitter:description" content="SPL简介1、SPL是Secondary Program Loader，也就是第二阶段引导启动程序。2、SPL是一套小的boot代码，主要负责初始化外部的DRAM和flash，然后引导启动u-boot。3、SPL是在u-boot代码中，与u-boot共用一套代码，通过CONFIG_SPL_XXX来区分。u-boot可以引导kernel，那么谁来引导u-boot呢？可以使用Rom code(Boot"><meta name="twitter:image" content="https://ae01.alicdn.com/kf/HTB1XgDda7L0gK0jSZFA763A9pXae.png"><script type="text/javascript" id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Pisces",version:"5.1.4",sidebar:{position:"right",display:"post",offset:12,b2t:!0,scrollpercent:!0,onmobile:!1},fancybox:!0,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},duoshuo:{userId:"0",author:"博主"},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><link rel="canonical" href="http://wowothink.com/1e031f74/"><title>u-boot SPL启动流程 | wowothink</title><script>!function(e,t,a,n,c,s,o){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,s=t.createElement(a),o=t.getElementsByTagName(a)[0],s.async=1,s.src=n,o.parentNode.insertBefore(s,o)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-146595331-1","auto"),ga("send","pageview")</script></head><body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans"><div class="container sidebar-position-right page-post-detail"><div class="headband"></div><header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">wowothink</span> <span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">thinking all the time</p></div><div class="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-folder"></i><br>归档</a></li><li class="menu-item menu-item-邮件"><a href="mailto:hsq_encourage@163.com" rel="section"><i class="menu-item-icon fa fa-fw fa-envelope"></i><br>邮件</a></li><li class="menu-item menu-item-博客"><a href="https://blog.csdn.net/encourage2011" rel="section"><i class="menu-item-icon fa fa-fw fa-crosshairs"></i><br>博客</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i> </span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"><input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="http://wowothink.com/1e031f74/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="name" content="Victor Huang"><meta itemprop="description" content=""><meta itemprop="image" content="/images/boy2.jpg"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="wowothink"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">u-boot SPL启动流程</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i> </span><span class="post-meta-item-text">发表于</span> <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-21T20:49:38+08:00">2019-07-21 </time></span><span class="post-category"><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-folder-o"></i> </span><span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/u-boot/" itemprop="url" rel="index"><span itemprop="name">u-boot</span></a></span></span><div class="post-wordcount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i> </span><span class="post-meta-item-text">字数统计&#58;</span> <span title="字数统计">1,704 </span><span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-clock-o"></i> </span><span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">8</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="SPL简介"><a href="#SPL简介" class="headerlink" title="SPL简介"></a>SPL简介</h2><p>1、SPL是<code>Secondary Program Loader</code>，也就是第二阶段引导启动程序。<br>2、SPL是一套小的boot代码，主要负责初始化外部的DRAM和flash，然后引导启动u-boot。<br>3、SPL是在u-boot代码中，与u-boot共用一套代码，通过<code>CONFIG_SPL_XXX</code>来区分。</p><p>u-boot可以引导kernel，那么谁来引导u-boot呢？可以使用<code>Rom code(Boot rom)</code>引导u-boot，也可以使用<code>SPL</code>引导u-boot。两者之间有啥差别呢？<br>1、如果<code>Rom code</code>直接引导u-boot，那么<code>Rom code</code>必须能够初始化外部DRAM又或者内部的SRAM足够大能够启动u-boot；<br>2、如果做不到，那么只能通过SPL来过渡。<code>Rom code</code>从外设flash上固定的地址读取SPL到内部的SRAM上运行，SPL去初始化外部的DRAM，然后将u-boot从flash上拷贝到外部的DRAM并启动u-boot。下面讲讲u-boot SPL启动流程<a id="more"></a></p><hr><h2 id="启动流程介绍"><a href="#启动流程介绍" class="headerlink" title="启动流程介绍"></a>启动流程介绍</h2><p>1、嵌入式Linux的启动流程(带SPL)如下：<br>Rom code –&gt; SPL –&gt; u-boot –&gt; Linux kernel –&gt; file system –&gt; application<br><img src="https://ae01.alicdn.com/kf/HTB1XgDda7L0gK0jSZFA763A9pXae.png" alt="嵌入式Linux的启动流程(带SPL)"></p><p>2、PC的启动流程为：<br>BIOS -&gt; MBR -&gt; GRUB -&gt; kernel</p><hr><h2 id="u-boot-spl流程"><a href="#u-boot-spl流程" class="headerlink" title="u-boot-spl流程"></a>u-boot-spl流程</h2><p>基本环境如下：</p><ul><li>u-boot版本：2018.03</li><li>开发板：imx8qxp mek</li><li>u-boot配置：打开SPL</li><li>u-boot：表示不带SPL的u-boot</li><li>u-boot-spl：表示已配置上SPL的u-boot</li></ul><hr><h3 id="u-boot-spl入口"><a href="#u-boot-spl入口" class="headerlink" title="u-boot-spl入口"></a>u-boot-spl入口</h3><p>u-boot-spl的入口同u-boot一样，也都是始于<code>arch/arm/cpu/armv8/start.S</code>中的<code>_start</code> → <code>lowlevel_init</code> → <code>_main</code>的调用顺序。也就是说，这个过程，spl会去执行一遍，不带spl的u-boot也会去执行一遍。中间通过<code>CONFIG_SPL_XXX</code>的宏进行区分。</p><h4 id="main简要说明"><a href="#main简要说明" class="headerlink" title="_main简要说明"></a><code>_main</code>简要说明</h4><p>根据<code>_main</code>的简要说明，里面会根据SPL做差分，走不同的流程。<br>1、对于u-boot-spl：</p><ul><li><code>_main</code>中会设置堆栈地址<code>CONFIG_SPL_STACK</code>，根据memory map，该地址属于<code>OCRAM</code>。这里就可以证明SPL是运行在<code>OCRAM</code>中的。</li><li><code>_main</code>中调用<code>board/freescale/imx8qxp_mek/spl.c</code>的<code>board_init_f()</code>；<figure class="highlight c"><figcaption><span>board/freescale/imx8qxp_mek/spl.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">board_init_f</span><span class="params">(ulong dummy)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">/* Clear global data */</span></span><br><span class="line">    <span class="built_in">memset</span>((<span class="keyword">void</span> *)gd, <span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">gd_t</span>));</span><br><span class="line"></span><br><span class="line">    arch_cpu_init();</span><br><span class="line"></span><br><span class="line">    board_early_init_f();</span><br><span class="line"></span><br><span class="line">    timer_init();</span><br><span class="line"></span><br><span class="line">    preloader_console_init();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Clear the BSS. */</span></span><br><span class="line">    <span class="built_in">memset</span>(__bss_start, <span class="number">0</span>, __bss_end - __bss_start);</span><br><span class="line"></span><br><span class="line">    board_init_r(<span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>2、对于u-boot来说：</p><ul><li><code>_main</code>中会设置堆栈地址<code>CONFIG_SYS_INIT_SP_ADDR</code>，根据memory map，该地址属于外部DRAM地址。这里就可以证明u-boot是运行在外部DDR上；</li><li><code>_main</code>调用<code>common/board_f.c</code>的<code>board_init_f()</code>，这里面做了更多的事情，<figure class="highlight c"><figcaption><span>common/board_f.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">board_init_f</span><span class="params">(ulong boot_flags)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    gd-&gt;flags = boot_flags;</span><br><span class="line">    gd-&gt;have_console = <span class="number">0</span>;</span><br><span class="line">                          </span><br><span class="line">    <span class="keyword">if</span> (initcall_run_list(init_sequence_f))</span><br><span class="line">        hang();</span><br><span class="line">   </span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> !defined(CONFIG_ARM) &amp;&amp; !defined(CONFIG_SANDBOX) &amp;&amp; \</span></span><br><span class="line">        !defined(CONFIG_EFI_APP) &amp;&amp; !CONFIG_IS_ENABLED(X86_64)</span><br><span class="line">    <span class="comment">/* NOTREACHED - jump_to_copy() does not return */</span></span><br><span class="line">    hang();</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h4 id="board-init-f-函数"><a href="#board-init-f-函数" class="headerlink" title="board_init_f()函数"></a><code>board_init_f()</code>函数</h4><p>1、对于u-boot-spl来说，在该函数中做了cpu、serial、timer、console的初始化，最终调用<code>common/spl/spl.c</code>中的<code>board_init_r()</code>函数。<br>2、对于u-boot来说，u-boot将需要在<code>board_init_f</code>中初始化的内容，抽象为一系列API，使用<code>init_sequence_f[]</code>数组定义。这些API由u-boot声明，由平台的开发者根据实际情况实现。在<code>_main</code>的最后，会调用<code>common/board_r.c</code>的<code>board_init_r()</code>函数。</p><hr><h4 id="board-init-r-函数"><a href="#board-init-r-函数" class="headerlink" title="board_init_r()函数"></a><code>board_init_r()</code>函数</h4><p>1、对于u-boot-spl来说，这个函数做了以下几件事：</p><ul><li>定义<code>spl_boot_list[]</code>，该数组存放从哪个boot device去启动，比如说SPI、nand、emmc等；</li><li>定义<code>struct spl_image_info spl_image</code>，用来标记uboot镜像存在哪个位置，启动地址是哪里，详见下面的定义；</li></ul><figure class="highlight c"><figcaption><span>include/spl.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spl_image_info</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    u8 os;</span><br><span class="line">    <span class="keyword">uintptr_t</span> load_addr;</span><br><span class="line">    <span class="keyword">uintptr_t</span> entry_point;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_IS_ENABLED(LOAD_FIT)</span></span><br><span class="line">    <span class="keyword">void</span> *fdt_addr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    u32 size;</span><br><span class="line">    u32 flags;</span><br><span class="line">    <span class="keyword">void</span> *arg;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DUAL_BOOTLOADER</span></span><br><span class="line">    <span class="keyword">uint64_t</span> rbindex;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><ul><li>如果定义了<code>CONFIG_SPL_OS_BOOT</code>宏，那么就去调用<code>dram_init_banksize()</code>函数做DRAM的初始化。这个宏表示直接跳过u-boot去启动kernel；</li><li>调用<code>mem_malloc_init()</code>为malloc分配空间，从<code>CONFIG_SYS_SPL_MALLOC_START</code>开始，大小为<code>CONFIG_SYS_SPL_MALLOC_SIZE</code>；</li><li>调用<code>spl_init()</code>；</li><li>调用<code>spl_board_init()</code>，该函数在<code>board/freescale/imx8qxp_mek/spl.c</code>中定义，主要做了<code>spl_dram_init()</code>的DDR初始化；</li><li>调用<code>board_boot_order()</code>去获取启动设备；</li><li>调用<code>boot_from_devices()</code>根据得到启动设备，从对应的设备中加载镜像到DDR中，使用<code>spl_load_image()</code>进行load；</li></ul><p>在<code>common/spl/</code>目录下定义了好几个启动设备，包括<code>spl_fat.c</code>、<code>spl_mmc.c</code>、<code>spl_nand.c</code>等。在这些文件中都通过<code>SPL_LOAD_IMAGE_METHOD</code>来定义<code>struct spl_image_info</code>的详细内容，并且实现<code>load_image</code>的实体函数，来将镜像从特定的boot device load到DDR中。<br></p><figure class="highlight c"><figcaption><span>common/spl/spl_mmc.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SPL_LOAD_IMAGE_METHOD(<span class="string">"MMC1"</span>, <span class="number">0</span>, BOOT_DEVICE_MMC1, spl_mmc_load_image);</span><br></pre></td></tr></table></figure><p></p><figure class="highlight c"><figcaption><span>include/spl.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Holds information about a way of loading an SPL image</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* @name: User-friendly name for this method (e.g. "MMC")</span></span><br><span class="line"><span class="comment">* @boot_device: Boot device that this loader supports</span></span><br><span class="line"><span class="comment">* @load_image: Function to call to load image</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spl_image_info</span> &#123;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line">    u8 os;</span><br><span class="line">    <span class="keyword">uintptr_t</span> load_addr;</span><br><span class="line">    <span class="keyword">uintptr_t</span> entry_point;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_IS_ENABLED(LOAD_FIT)</span></span><br><span class="line">    <span class="keyword">void</span> *fdt_addr;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    u32 size;</span><br><span class="line">    u32 flags;</span><br><span class="line">    <span class="keyword">void</span> *arg;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DUAL_BOOTLOADER</span></span><br><span class="line">    <span class="keyword">uint64_t</span> rbindex;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Holds information about a way of loading an SPL image</span></span><br><span class="line"><span class="comment">*               </span></span><br><span class="line"><span class="comment">* @name: User-friendly name for this method (e.g. "MMC")</span></span><br><span class="line"><span class="comment">* @boot_device: Boot device that this loader supports</span></span><br><span class="line"><span class="comment">* @load_image: Function to call to load image</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">spl_image_loader</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SPL_LIBCOMMON_SUPPORT</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *name;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></span><br><span class="line">    uint boot_device;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * load_image() - Load an SPL image</span></span><br><span class="line"><span class="comment">     *  </span></span><br><span class="line"><span class="comment">     * @spl_image: place to put image information</span></span><br><span class="line"><span class="comment">     * @bootdev: describes the boot device to load from</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> (*load_image)(struct spl_image_info *spl_image,</span><br><span class="line">              struct spl_boot_device *bootdev);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* Declare an SPL image loader */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPL_LOAD_IMAGE(__name)                  \</span></span><br><span class="line">    ll_entry_declare(struct spl_image_loader, __name, spl_image_loader)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* _priority is the priority of this method, 0 meaning it will be the top</span></span><br><span class="line"><span class="comment">* choice for this device, 9 meaning it is the bottom choice.</span></span><br><span class="line"><span class="comment">* _boot_device is the BOOT_DEVICE_... value</span></span><br><span class="line"><span class="comment">* _method is the load_image function to call</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> SPL_LOAD_IMAGE_METHOD(_name, _priority, _boot_device, _method) \</span></span><br><span class="line">    SPL_LOAD_IMAGE(_method ## _priority ## _boot_device) = &#123; \</span><br><span class="line">        .name = _name, \  </span><br><span class="line">        .boot_device = _boot_device, \</span><br><span class="line">        .load_image = _method, \</span><br><span class="line">    &#125;</span><br><span class="line">#<span class="keyword">else</span></span><br><span class="line">#define SPL_LOAD_IMAGE_METHOD(_name, _priority, _boot_device, _method) \</span><br><span class="line">    SPL_LOAD_IMAGE(_method ## _priority ## _boot_device) = &#123; \</span><br><span class="line">        .boot_device = _boot_device, \</span><br><span class="line">        .load_image = _method, \</span><br><span class="line">    &#125;                     </span><br><span class="line">#endif</span><br></pre></td></tr></table></figure><ul><li>调用<code>spl_load_image()</code>函数从对应的boot device将镜像信息存放到<code>spl_image</code>中，</li></ul><figure class="highlight c"><figcaption><span>common/spl/spl.c</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">spl_load_image</span><span class="params">(struct spl_image_info *spl_image,</span></span></span><br><span class="line"><span class="function"><span class="params">              struct spl_image_loader *loader)</span></span></span><br><span class="line"><span class="function"></span>&#123;  </span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">spl_boot_device</span> <span class="title">bootdev</span>;</span></span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    bootdev.boot_device = loader-&gt;boot_device;  </span><br><span class="line">    bootdev.boot_device_name = <span class="literal">NULL</span>;</span><br><span class="line">   </span><br><span class="line">    ret = loader-&gt;load_image(spl_image, &amp;bootdev);</span><br><span class="line">    <span class="keyword">return</span> ret;           </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>load完镜像后，默认会去调用<code>spl_board_prepare_for_boot()</code>和<code>jump_to_image_no_args()</code>去<code>jumping to U-Boot</code>。至此，u-boot-spl的流程就走完了，接下来就是走u-boot的流程。</li></ul><hr><h2 id="imx8x的做法"><a href="#imx8x的做法" class="headerlink" title="imx8x的做法"></a>imx8x的做法</h2><p>根据[i.MX_Linux_User’s_Guide.pdf]的说明，</p><blockquote><p>On i.MX 8M Quad and 8M Mini, the second program loader (SPL) is enabled in U-Boot. SPL is implemented as the firstlevel bootloader running on TCML (due to OCRAM size limitation). It is used to initialize DDR and load U-Boot, U-Boot DTB, Arm trusted firmware, and TEE OS (optional) from the boot device into the memory. After SPL completes loading the images, it jumps to the Arm trusted firmware BL31 directly. The BL31 starts the optional BL32 (TEE OS) and BL33 (u-boot) for continue booting kernel.</p></blockquote><p>在i.MX8MQ 和 i.MX8MM，在u-boot中是使能SPL。SPL跑在<code>TCML(Tightly-Coupled Memory)</code>内存上，SPL用于初始化DDR并从flash上加载u-boot、u-boot dtb、ATF、TEE到DDR上。SPL加载镜像完毕之后，直接跳转到ATF BL31阶段，BL31再去启动BL32(TEE)和BL33(u-boot)，u-boot再去启动kernel。</p><p><strong>注：</strong>在i.MX8QXP的CPU上，它的<code>Rom code</code>在上电的时候会根据boot mode从对应的flash上特定的位置读取到flash.bin，将打包到其中的<code>dcd cfg</code>的DDR配置读取出来然后初始化外部的DRAM。</p><hr><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><div class="note success"><p><a href="https://stackoverflow.com/questions/31244862/what-is-the-use-of-spl-secondary-program-loader/31252989" target="_blank" rel="noopener">what is the use of SPL</a><br><a href="https://blog.csdn.net/ooonebook/article/details/52957395" target="_blank" rel="noopener">uboot流程——uboot-spl代码流程</a><br><a href="http://wowothink.com/146db8db/">u-boot启动流程</a></p></div></div><div><div class="my_post_copyright"><script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script><script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script><script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script><p><span>Title:</span><a href="/1e031f74/">u-boot SPL启动流程</a></p><p><span>Author:</span><a href="/" title="Visit Victor Huang blog">Victor Huang</a></p><p><span>Time:</span>2019-07-21 / 21:07</p><p><span>Link:</span><a href="/1e031f74/" title="u-boot SPL启动流程">http://wowothink.com/1e031f74/</a> <span class="copy-path" title="click to copy link"><i class="fa fa-clipboard" data-clipboard-text="http://wowothink.com/1e031f74/" aria-label="copy link success"></i></span></p><p><span>License:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)</a></p></div><script>var clipboard=new Clipboard(".fa-clipboard");$(".fa-clipboard").click(function(){clipboard.on("success",function(){swal({title:"",text:"copy link success",icon:"success",showConfirmButton:!0})})})</script></div><footer class="post-footer"><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/5ade33b8/" rel="next" title="uboot fastboot原理"><i class="fa fa-chevron-left"></i> uboot fastboot原理</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"><a href="/5ed212d1/" rel="prev" title="iperf的使用">iperf的使用 <i class="fa fa-chevron-right"></i></a></div></div></footer></div></article><div class="post-spread"></div></div></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span> <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span> <span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap">站点概览</li></ul><section class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="site-author-image" itemprop="image" src="/images/boy2.jpg" alt="Victor Huang"><p class="site-author-name" itemprop="name">Victor Huang</p><p class="site-description motion-element" itemprop="description"></p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"><a href="/archives/"><span class="site-state-item-count">81</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"><a href="/categories/index.html"><span class="site-state-item-count">18</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"><a href="/tags/index.html"><span class="site-state-item-count">17</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="mailto:hsq_encourage@163.com" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a> </span><span class="links-of-author-item"><a href="https://blog.csdn.net/encourage2011" target="_blank" title="CSDN博客"><i class="fa fa-fw fa-crosshairs"></i>CSDN博客</a></span></div></div></section><section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#SPL简介"><span class="nav-number">1.</span> <span class="nav-text">SPL简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动流程介绍"><span class="nav-number">2.</span> <span class="nav-text">启动流程介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#u-boot-spl流程"><span class="nav-number">3.</span> <span class="nav-text">u-boot-spl流程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#u-boot-spl入口"><span class="nav-number">3.1.</span> <span class="nav-text">u-boot-spl入口</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#main简要说明"><span class="nav-number">3.1.1.</span> <span class="nav-text">_main简要说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#board-init-f-函数"><span class="nav-number">3.1.2.</span> <span class="nav-text">board_init_f()函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#board-init-r-函数"><span class="nav-number">3.1.3.</span> <span class="nav-text">board_init_r()函数</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#imx8x的做法"><span class="nav-number">4.</span> <span class="nav-text">imx8x的做法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-number">5.</span> <span class="nav-text">参考资料</span></a></li></ol></div></div></section><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span id="scrollpercent"><span>0</span>%</span></div><script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script><script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script><div class="widget-wrap"><div id="myCanvasContainer" class="widget tagcloud"><canvas width="200" height="200" id="resCanvas"><ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android编译相关/">Android编译相关</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-Kernel/">Linux Kernel</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-Kernel优化/">Linux Kernel优化</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-USB/">Linux USB</a><span class="tag-list-count">10</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-driver/">Linux driver</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-性能测试/">Linux 性能测试</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Python脚本/">Python脚本</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eMMC/">eMMC</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/i-MX6/">i.MX6</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/i-MX8/">i.MX8</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/u-boot/">u-boot</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu工具/">ubuntu工具</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/在家学习嵌入式/">在家学习嵌入式</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/备忘记录/">备忘记录</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/碰到的问题/">碰到的问题</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/网站记录/">网站记录</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/调试工具/">调试工具</a><span class="tag-list-count">2</span></li></ul></canvas></div></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2020</span> <span class="with-love"><i class="fa fa-user"></i> </span><span class="author" itemprop="copyrightHolder">Victor Huang</span> <span class="post-meta-divider">|</span> <span class="post-meta-item-icon"><i class="fa fa-area-chart"></i> </span><span class="post-meta-item-text">Site words total count&#58;</span> <span title="Site words total count">104.7k</span></div></div></footer></div><script type="text/javascript">"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script><script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script><script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script><script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script><script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script><script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script><script type="text/javascript">function proceedsearch(){$("body").append('<div class="search-popup-overlay local-search-pop-overlay"></div>').css("overflow","hidden"),$(".search-popup-overlay").click(onPopupClose),$(".popup").toggle();var t=$("#local-search-input");t.attr("autocapitalize","none"),t.attr("autocorrect","off"),t.focus()}var isfetched=!1,isXml=!0,search_path="./public/search.xml";0===search_path.length?search_path="search.xml":/json$/i.test(search_path)&&(isXml=!1);var path="/"+search_path,onPopupClose=function(t){$(".popup").hide(),$("#local-search-input").val(""),$(".search-result-list").remove(),$("#no-result").remove(),$(".local-search-pop-overlay").remove(),$("body").css("overflow","")},searchFunc=function(t,e,o){"use strict";$("body").append('<div class="search-popup-overlay local-search-pop-overlay"><div id="search-loading-icon"><i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i></div></div>').css("overflow","hidden"),$("#search-loading-icon").css("margin","20% auto 0 auto").css("text-align","center"),$.ajax({url:t,dataType:isXml?"xml":"json",async:!0,success:function(t){isfetched=!0,$(".popup").detach().appendTo(".header-inner");var n=isXml?$("entry",t).map(function(){return{title:$("title",this).text(),content:$("content",this).text(),url:$("url",this).text()}}).get():t,r=document.getElementById(e),s=document.getElementById(o),a=function(){var t=r.value.trim().toLowerCase(),e=t.split(/[\s\-]+/);e.length>1&&e.push(t);var o=[];if(t.length>0&&n.forEach(function(n){function r(e,o,n,r){for(var s=r[r.length-1],a=s.position,i=s.word,l=[],h=0;a+i.length<=n&&0!=r.length;){i===t&&h++,l.push({position:a,length:i.length});var p=a+i.length;for(r.pop();0!=r.length&&(s=r[r.length-1],a=s.position,i=s.word,p>a);)r.pop()}return c+=h,{hits:l,start:o,end:n,searchTextCount:h}}function s(t,e){var o="",n=e.start;return e.hits.forEach(function(e){o+=t.substring(n,e.position);var r=e.position+e.length;o+='<b class="search-keyword">'+t.substring(e.position,r)+"</b>",n=r}),o+=t.substring(n,e.end)}var a=!1,i=0,c=0,l=n.title.trim(),h=l.toLowerCase(),p=n.content.trim().replace(/<[^>]+>/g,""),u=p.toLowerCase(),f=decodeURIComponent(n.url),d=[],g=[];if(""!=l&&(e.forEach(function(t){function e(t,e,o){var n=t.length;if(0===n)return[];var r=0,s=[],a=[];for(o||(e=e.toLowerCase(),t=t.toLowerCase());(s=e.indexOf(t,r))>-1;)a.push({position:s,word:t}),r=s+n;return a}d=d.concat(e(t,h,!1)),g=g.concat(e(t,u,!1))}),(d.length>0||g.length>0)&&(a=!0,i=d.length+g.length)),a){[d,g].forEach(function(t){t.sort(function(t,e){return e.position!==t.position?e.position-t.position:t.word.length-e.word.length})});var v=[];0!=d.length&&v.push(r(l,0,l.length,d));for(var $=[];0!=g.length;){var C=g[g.length-1],m=C.position,x=C.word,w=m-20,y=m+80;0>w&&(w=0),y<m+x.length&&(y=m+x.length),y>p.length&&(y=p.length),$.push(r(p,w,y,g))}$.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hits.length!==e.hits.length?e.hits.length-t.hits.length:t.start-e.start});var T=parseInt("1");T>=0&&($=$.slice(0,T));var b="";b+=0!=v.length?"<li><a href='"+f+"' class='search-result-title'>"+s(l,v[0])+"</a>":"<li><a href='"+f+"' class='search-result-title'>"+l+"</a>",$.forEach(function(t){b+="<a href='"+f+'\'><p class="search-result">'+s(p,t)+"...</p></a>"}),b+="</li>",o.push({item:b,searchTextCount:c,hitCount:i,id:o.length})}}),1===e.length&&""===e[0])s.innerHTML='<div id="no-result"><i class="fa fa-search fa-5x" /></div>';else if(0===o.length)s.innerHTML='<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>';else{o.sort(function(t,e){return t.searchTextCount!==e.searchTextCount?e.searchTextCount-t.searchTextCount:t.hitCount!==e.hitCount?e.hitCount-t.hitCount:e.id-t.id});var a='<ul class="search-result-list">';o.forEach(function(t){a+=t.item}),a+="</ul>",s.innerHTML=a}};r.addEventListener("input",a),$(".local-search-pop-overlay").remove(),$("body").css("overflow",""),proceedsearch()}})};$(".popup-trigger").click(function(t){t.stopPropagation(),isfetched===!1?searchFunc(path,"local-search-input","local-search-result"):proceedsearch()}),$(".popup-btn-close").click(onPopupClose),$(".popup").click(function(t){t.stopPropagation()}),$(document).on("keyup",function(t){var e=27===t.which&&$(".search-popup").is(":visible");e&&onPopupClose()})</script><script>!function(){var t=document.createElement("script"),s=window.location.protocol.split(":")[0];"https"===s?t.src="https://zz.bdstatic.com/linksubmit/push.js":t.src="http://push.zhanzhang.baidu.com/push.js";var e=document.getElementsByTagName("script")[0];e.parentNode.insertBefore(t,e)}()</script><script type="text/javascript" src="/js/src/clipboard.js"></script><script type="text/javascript" src="/js/src/clipboard-use.js"></script></body></html><!-- rebuild by neat -->